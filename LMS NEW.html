<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archipelago Group - Leave Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --light: #ecf0f1;
            --dark: #34495e;
            --white: #ffffff;
            --gray: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light);
        }

        .login-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            position: relative;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-logo span {
            color: var(--secondary);
        }

        .login-title {
            font-size: 18px;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light);
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background-color: #16a085;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }

        .table th {
            background-color: var(--primary);
            color: var(--white);
        }

        .table tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background-color: var(--success);
            color: var(--white);
        }

        .badge-warning {
            background-color: var(--warning);
            color: var(--white);
        }

        .badge-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .badge-info {
            background-color: var(--info);
            color: var(--white);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--white);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--secondary);
            color: var(--secondary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .leave-balance-card {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-item {
            flex: 1;
            min-width: 150px;
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .balance-item h3 {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .balance-item p {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light);
        }

        .modal-title {
            font-size: 20px;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--light);
        }

        .password-requirements {
            margin-top: 5px;
            font-size: 12px;
            color: var(--gray);
        }

        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }

        .requirement i {
            margin-right: 5px;
            font-size: 10px;
        }

        .requirement.valid {
            color: var(--success);
        }

        .requirement.invalid {
            color: var(--gray);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            margin-right: 15px;
            font-size: 20px;
            color: var(--white);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .leave-balance-toggle {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .leave-balance-table {
            display: none;
            margin-top: 10px;
        }

        .leave-balance-table.show {
            display: block;
        }

        .employee-checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--light);
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .employee-checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }

        .employee-checkbox-item input {
            margin-right: 10px;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light);
        }

        .card-title {
            font-size: 18px;
            color: var(--primary);
        }

        .text-muted {
            color: var(--gray);
            font-size: 12px;
        }

        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: bold;
        }

        .logo img {
            height: 100px;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--secondary);
            color: var(--white);
        }

        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
        }

        .info-icon {
            position: absolute;
            right: 30px;
            top: 145px;
            color: var(--secondary);
            cursor: pointer;
        }

        .info-tooltip {
            position: absolute;
            background-color: var(--dark);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            width: 250px;
            right: 30px;
            top: 170px;
            display: none;
            z-index: 100;
        }

        .table-responsive {
            overflow-x: auto;
        }

        /* Notification dropdown */
        .notification-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background-color: #f9f9f9;
        }

        .notification-item .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-item .notification-time {
            font-size: 12px;
            color: #777;
        }

        .notification-item .notification-message {
            font-size: 14px;
        }

        /* Edit leave balance modal */
        .edit-balance-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        
            .sidebar {
                margin-bottom: 20px;
            }

            .leave-balance-card {
                flex-direction: column;
            }
            
            .employee-actions {
                flex-direction: column;
            }

            .notification-dropdown {
                width: 280px;
                right: -50px;
            }

            .edit-balance-form {
                grid-template-columns: 1fr;
            }
        }
        /* Make employee list table more compact */
.compact-table {
    font-size: 13px;
}
.compact-table th, 
.compact-table td {
    padding: 8px 10px;
}
.compact-table .btn-sm {
    padding: 3px 6px;
    font-size: 11px;
}

/* Styles for the view leave details modal */
#viewLeaveModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
#viewLeaveModal .modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
}
#viewLeaveModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}
#viewLeaveModal .modal-title {
    font-size: 18px;
    font-weight: bold;
}
#viewLeaveModal .close-modal {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}
#viewLeaveModal .leave-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}
#viewLeaveModal .leave-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #viewLeaveModal .leave-details-grid {
        grid-template-columns: 1fr;
    }
}
/* Style for disabled dates in date picker */
.flatpickr-day.disabled, 
.flatpickr-day.disabled:hover, 
.flatpickr-day.prevMonthDay.disabled, 
.flatpickr-day.nextMonthDay.disabled {
    color: #ccc;
    background: #f7f7f7;
    cursor: not-allowed;
    border-color: transparent;
}

/* Style for weekends */
.flatpickr-day.weekend {
    color: #ccc;
    background: #f7f7f7;
}
/* Add this to your existing CSS */
.flatpickr-day.disabled, 
.flatpickr-day.disabled:hover, 
.flatpickr-day.prevMonthDay.disabled, 
.flatpickr-day.nextMonthDay.disabled {
    color: #ccc !important;
    background: #f9f9f9 !important;
    cursor: not-allowed !important;
    border-color: transparent !important;
}

.flatpickr-day.weekend {
    color: #ccc !important;
    background: #f9f9f9 !important;
}

.flatpickr-day.holiday {
    color: #ff0000 !important;
    background: #fff0f0 !important;
}

#viewLeaveModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

#viewLeaveModal .modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
}

#viewLeaveModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

#viewLeaveModal .modal-title {
    font-size: 18px;
    font-weight: bold;
}

#viewLeaveModal .close-modal {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

#viewLeaveModal .leave-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

#viewLeaveModal .leave-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

@media (max-width: 768px) {
    #viewLeaveModal .leave-details-grid {
        grid-template-columns: 1fr;
    }
}
/* Modification Tab Styles - Wider Version */
.modification-tab {
    display: none;
    background-color: #f8f9fa;
    padding: 20px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 10px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 800px; /* Set a max-width for better readability */
    margin-left: auto;
    margin-right: auto;
}

.modification-tab.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.modification-header {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
}

.modification-form {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 10px;
}

.modification-form .form-group {
    margin-bottom: 15px;
}

.modification-form label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--dark);
}

.modification-form .form-control,
.modification-form .form-select {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
}

.modification-actions {
    grid-column: 1 / -1;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

/* Remove the table cell styling */
#leaveRequestsTable tr + tr .modification-tab {
    border: none;
    background: transparent;
    padding: 0;
    margin: 20px 0;
}

/* Make date range inputs appear on same line */
.modification-form .date-range-group {
    display: flex;
    gap: 15px;
}

.modification-form .date-range-group .form-group {
    flex: 1;
}

@media (max-width: 768px) {
    .modification-form {
        grid-template-columns: 1fr;
    }
    
    .modification-form .date-range-group {
        flex-direction: column;
        gap: 10px;
    }
}
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">Archipelago <span>LMS</span></div>
                <div class="login-title">Leave Management System</div>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <div class="password-container">
                        <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                        <span class="toggle-password"><i class="far fa-eye"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </div>
            </form>
            <div class="login-footer">
                <a href="#" id="forgotPasswordLink">Forgot Password?</a>
            </div>
            <i class="fas fa-info-circle info-icon" id="infoIcon"></i>
            <div class="info-tooltip" id="infoTooltip">
                USE EMAIL NAME<br>
                Example: mags@archipelagogrp.com<br>
                USERNAME: mags
            </div>
        </div>
    </div>

    <!-- Dashboard Pages -->
    <div id="dashboardPage" style="display: none;">
        <header>
            <div class="container header-content">
<div class="logo">
    <img src="https://cdn.brandfetch.io/archipelagogrp.com/fallback/lettermark/theme/dark/h/256/w/256/icon?c=1bfwsmEH20zzEfSNTed" alt="Company Logo">
    <span>Archipelago <span>LMS</span></span>
</div>
                <div class="user-info">
                    <span id="welcomeMessage">Welcome, User</span>
                    <div class="notification-bell-container">
                        <div class="notification-bell" id="notificationBell">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </div>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                    <button class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="dashboard">
                <div class="sidebar">
                    <ul class="sidebar-menu" id="sidebarMenu">
                        <!-- Dynamic sidebar content will be inserted here based on user role -->
                    </ul>
                </div>

                <div class="main-content" id="mainContent">
                    <!-- Dynamic main content will be inserted here based on user role and selected menu -->
                </div>
            </div>
        </div>
    </div>

    <!-- Common Modals -->
    <div class="modal" id="applyLeaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Apply for Leave</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="leaveForm">
                <div class="form-group">
                    <label for="leaveType" class="form-label">Leave Type</label>
                    <select id="leaveType" class="form-select" required>
                        <option value="">Select Leave Type</option>
                        <option value="annual">Annual Leave</option>
                        <option value="emergency">Emergency Leave</option>
                        <option value="medical">Medical Leave</option>
                        <option value="marriage">Marriage Leave</option>
                        <option value="maternity">Maternity Leave (60 days)</option>
                        <option value="paternity">Paternity Leave (2 days)</option>
                        <option value="compassionate">Compassionate Leave</option>
                        <option value="study">Study Leave</option>
                        <option value="examination">Examination Leave</option>
                        <option value="replacement">Replacement Leave</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="leaveDuration" class="form-label">Duration</label>
                    <select id="leaveDuration" class="form-select" required>
                        <option value="">Select Duration</option>
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                        <option value="multiple">Multiple Days</option>
                    </select>
                </div>

                <div class="form-group" id="halfDayGroup" style="display: none;">
                    <label for="halfDayTime" class="form-label">Half Day Time</label>
                    <select id="halfDayTime" class="form-select">
                        <option value="morning">Morning</option>
                        <option value="afternoon">Afternoon</option>
                    </select>
                </div>

                <div class="form-group" id="singleDateGroup">
                    <label for="leaveDate" class="form-label">Date</label>
                    <input type="text" id="leaveDate" class="form-control datepicker" placeholder="Select date" required>
                </div>

                <div class="form-group" id="dateRangeGroup" style="display: none;">
                    <label for="leaveStartDate" class="form-label">Start Date</label>
                    <input type="text" id="leaveStartDate" class="form-control datepicker" placeholder="Select start date">

                    <label for="leaveEndDate" class="form-label" style="margin-top: 10px;">End Date</label>
                    <input type="text" id="leaveEndDate" class="form-control datepicker" placeholder="Select end date">
                </div>

                <div class="form-group">
                    <label for="leaveRemark" class="form-label">Remark</label>
                    <textarea id="leaveRemark" class="form-control" rows="3" placeholder="Enter remark for leave" required></textarea>
                </div>

                <div class="form-group" id="documentUploadGroup" style="display: none;">
                    <label for="leaveDocument" class="form-label">Supporting Document</label>
                    <input type="file" id="leaveDocument" class="form-control" accept=".pdf,.jpg,.jpeg">                    <small class="text-muted">Required for all leave types except Annual and Emergency Leave</small>
                </div>

                <div class="form-group">
                    <label for="contactNumber" class="form-label">Contact Number During Leave</label>
                    <input type="tel" id="contactNumber" class="form-control" placeholder="Enter contact number" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword" class="form-label">Current Password</label>
                    <div class="password-container">
                        <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required>
                        <span class="toggle-password"><i class="far fa-eye"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword" class="form-label">New Password</label>
                    <div class="password-container">
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                        <span class="toggle-password"><i class="far fa-eye"></i></span>
                    </div>
                    <div class="password-requirements">
                        <div class="requirement invalid" id="lengthReq">
                            <i class="far fa-circle"></i> Minimum 8 characters
                        </div>
                        <div class="requirement invalid" id="upperReq">
                            <i class="far fa-circle"></i> At least 1 uppercase letter (A,B)
                        </div>
                        <div class="requirement invalid" id="lowerReq">
                            <i class="far fa-circle"></i> At least 1 lowercase letter (a,b)
                        </div>
                        <div class="requirement invalid" id="numberReq">
                            <i class="far fa-circle"></i> At least 1 number (1,2,3)
                        </div>
                        <div class="requirement invalid" id="specialReq">
                            <i class="far fa-circle"></i> At least 1 special character (@#$)
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                    <div class="password-container">
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                        <span class="toggle-password"><i class="far fa-eye"></i></span>
                    </div>
                    <small id="passwordMatch" class="text-muted"></small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="savePasswordBtn" disabled>Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="rejectLeaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Leave Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="rejectLeaveForm">
                <input type="hidden" id="rejectLeaveId">
                <div class="form-group">
                    <label for="rejectRemark" class="form-label">Remark for Rejection</label>
                    <textarea id="rejectRemark" class="form-control" rows="3" placeholder="Enter remark for rejection" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Submit Rejection</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="viewLeaveBalanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Employee Leave Balances</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Leave Type</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="leaveBalanceTableBody">
                        <!-- Leave balances will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger close-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- HR Modals -->
    <div class="modal" id="addHolidayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Public Holiday</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="holidayForm">
                <div class="form-group">
                    <label for="holidayName" class="form-label">Holiday Name</label>
                    <input type="text" id="holidayName" class="form-control" placeholder="Enter holiday name" required>
                </div>
                <div class="form-group">
                    <label for="holidayDate" class="form-label">Date</label>
                    <input type="text" id="holidayDate" class="form-control datepicker" placeholder="Select date" required>
                </div>
                <div class="form-group">
                    <label for="holidayDuration" class="form-label">Duration</label>
                    <select id="holidayDuration" class="form-select" required>
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                    </select>
                </div>
                <div class="form-group" id="holidayHalfDayGroup" style="display: none;">
                    <label for="holidayHalfDayTime" class="form-label">Half Day Time</label>
                    <select id="holidayHalfDayTime" class="form-select">
                        <option value="morning">Morning</option>
                        <option value="afternoon">Afternoon</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Holiday</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addUnrecordedLeaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Unrecorded Leave</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="unrecordedLeaveForm">
                <div class="form-group">
                    <label for="unrecordedLeaveName" class="form-label">Leave Name</label>
                    <input type="text" id="unrecordedLeaveName" class="form-control" placeholder="Enter leave name" required>
                </div>
                <div class="form-group">
                    <label for="unrecordedLeaveDate" class="form-label">Date</label>
                    <input type="text" id="unrecordedLeaveDate" class="form-control datepicker" placeholder="Select date" required>
                </div>
                <div class="form-group">
                    <label for="unrecordedLeaveDuration" class="form-label">Duration</label>
                    <select id="unrecordedLeaveDuration" class="form-select" required>
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                    </select>
                </div>
                <div class="form-group" id="unrecordedHalfDayGroup" style="display: none;">
                    <label for="unrecordedHalfDayTime" class="form-label">Half Day Time</label>
                    <select id="unrecordedHalfDayTime" class="form-select">
                        <option value="morning">Morning</option>
                        <option value="afternoon">Afternoon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unrecordedLeaveScope" class="form-label">Apply To</label>
                    <select id="unrecordedLeaveScope" class="form-select" required>
                        <option value="all">All Employees</option>
                        <option value="selected">Selected Employees</option>
                    </select>
                </div>
                <div class="form-group" id="selectedEmployeesGroup" style="display: none;">
                    <label class="form-label">Select Employees</label>
                    <div class="employee-checkbox-list" id="employeeCheckboxList">
                        <!-- Employees will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Leave</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="manageSupervisorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Supervisor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="supervisorForm">
                <div class="form-group">
                    <label for="supervisorAction" class="form-label">Action</label>
                    <select id="supervisorAction" class="form-select" required>
                        <option value="">Select Action</option>
                        <option value="add">Add Supervisor</option>
                        <option value="delete">Delete Supervisor</option>
                    </select>
                </div>
                <div class="form-group" id="addSupervisorGroup">
                    <label for="newSupervisorName" class="form-label">Supervisor Name</label>
                    <input type="text" id="newSupervisorName" class="form-control" placeholder="Enter supervisor name">
                </div>
                <div class="form-group" id="deleteSupervisorGroup" style="display: none;">
                    <label for="supervisorToDelete" class="form-label">Select Supervisor</label>
                    <select id="supervisorToDelete" class="form-select">
                        <!-- Supervisors will be populated dynamically -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="manageEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Employee</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="employeeForm">
                <div class="form-group">
                    <label for="employeeAction" class="form-label">Action</label>
                    <select id="employeeAction" class="form-select" required>
                        <option value="">Select Action</option>
                        <option value="add">Add Employee</option>
                        <option value="move">Move Employee</option>
                        <option value="delete">Delete Employee</option>
                    </select>
                </div>
                <div class="form-group" id="employeeSelectionGroup" style="display: none;">
                    <label for="selectedEmployee" class="form-label">Select Employee</label>
                    <select id="selectedEmployee" class="form-select">
                        <!-- Employees will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group" id="employeeDetailsGroup" style="display: none;">
                    <div id="addEmployeeGroup">
                        <label for="employeeName" class="form-label">Full Name</label>
                        <input type="text" id="employeeName" class="form-control" placeholder="Enter employee name">
                        
                        <label for="employeeUsername" class="form-label">Username</label>
                        <input type="text" id="employeeUsername" class="form-control" placeholder="Enter username">
                        
                        <label for="employeeEmail" class="form-label">Email</label>
                        <input type="email" id="employeeEmail" class="form-control" placeholder="Enter email">
                        
                        <label for="employeeSupervisor" class="form-label">Supervisor</label>
                        <select id="employeeSupervisor" class="form-select">
                            <!-- Supervisors will be populated dynamically -->
                        </select>
                        
                        <label for="employeeRole" class="form-label">Role</label>
                        <select id="employeeRole" class="form-select">
                            <option value="employee">Employee</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="hr">HR</option>
                        </select>
                        
                        <div id="supervisorSupervisorsGroup" style="display: none;">
                            <label for="supervisorSupervisors" class="form-label">Supervisors to Manage</label>
                            <select id="supervisorSupervisors" class="form-select" multiple>
                                <!-- Supervisors will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div id="moveEmployeeGroup" style="display: none;">
                        <label for="moveToSupervisor" class="form-label">Move to Supervisor</label>
                        <select id="moveToSupervisor" class="form-select">
                            <!-- Supervisors will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editLeaveBalanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Leave Balance</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="leaveBalanceForm">
                <input type="hidden" id="balanceEmployeeId">
                <div class="edit-balance-form">
                    <div class="form-group">
                        <label class="form-label">Employee</label>
                        <p id="balanceEmployeeName" style="font-weight: bold;"></p>
                    </div>
                    <div class="form-group">
                        <label for="balanceLeaveType" class="form-label">Leave Type</label>
                        <select id="balanceLeaveType" class="form-select" required>
                            <option value="annual">Annual Leave</option>
                            <option value="emergency">Emergency Leave</option>
                            <option value="medical">Medical Leave</option>
                            <option value="marriage">Marriage Leave</option>
                            <option value="maternity">Maternity Leave</option>
                            <option value="paternity">Paternity Leave</option>
                            <option value="compassionate">Compassionate Leave</option>
                            <option value="study">Study Leave</option>
                            <option value="examination">Examination Leave</option>
                            <option value="replacement">Replacement Leave</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="balanceDays" class="form-label">Days</label>
                        <input type="number" id="balanceDays" class="form-control" min="0" step="0.5" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Balance</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="viewEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Employee Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="employeeDetailsContent">
                <!-- Employee details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger close-modal">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Forgot Password</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="forgotUsername" class="form-label">Username</label>
                    <input type="text" id="forgotUsername" class="form-control" placeholder="Enter your username" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Reset Password</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editLeaveBalanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Leave Balance</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="leaveBalanceForm">
                <input type="hidden" id="balanceEmployeeId">
                <div class="form-group">
                    <label for="balanceEmployee" class="form-label">Employee</label>
                    <select id="balanceEmployee" class="form-select" disabled>
                        <!-- Employees will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="balanceLeaveType" class="form-label">Leave Type</label>
                    <select id="balanceLeaveType" class="form-select" required>
                        <option value="annual">Annual Leave</option>
                        <option value="emergency">Emergency Leave</option>
                        <option value="medical">Medical Leave</option>
                        <option value="marriage">Marriage Leave</option>
                        <option value="maternity">Maternity Leave</option>
                        <option value="paternity">Paternity Leave</option>
                        <option value="compassionate">Compassionate Leave</option>
                        <option value="study">Study Leave</option>
                        <option value="examination">Examination Leave</option>
                        <option value="replacement">Replacement Leave</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="balanceDays" class="form-label">Days</label>
                    <input type="number" id="balanceDays" class="form-control" min="0" step="0.5" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Balance</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Sample Data Storage
        const defaultLeaveBalances = {
            annual: 14,
            emergency: 7, // Combined with annual leave
            medical: 14,
            marriage: 3,
            maternity: 98,
            paternity: 7,
            compassionate: 7,
            study: 3,
            examination: 365,
            replacement: 0
        };

        const supervisors = [
            { id: 1, name: "Mr IAN" },
            { id: 2, name: "ADRIAN TAY" },
            { id: 3, name: "MARK ANTHONY" },
            { id: 4, name: "AHMED FAROUK" },
            { id: 5, name: "ADELINE" },
            { id: 6, name: "JAYMEE LOH" },
            { id: 7, name: "MAGESON" },
            { id: 8, name: "CHLOE" },
            { id: 9, name: "JANE" },
            { id: 10, name: "CHEAH GOON SENG" },
            { id: 11, name: "PUA HOOI TENG" },
            { id: 12, name: "SHAHIEDATUL ZHAFIRAH" },
            { id: 13, name: "PRISCILLA" },
        ];

        let users = [
            { 
                id: 1, 
                username: "mags", 
                password: "password123", 
                name: "MAGS", 
                role: "hr", 
                supervisor: "MARK ANTHONY", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "mags@archipelagogrp.com"
            },
            // Mr IAN's supervisor
            { 
                id: 2, 
                username: "ian.lim", 
                password: "password123", 
                name: "Mr IAN", 
                role: "supervisor", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["ADRIAN TAY", "MARK ANTHONY", "AHMED FAROUK", "KROSE ANAK RAWONG", "SIMON HARDI", "PUA HOOI TENG"],
                email: "ian.lim@archipelagogrp.com"
            },
            { 
                id: 3, 
                username: "adrian.tay", 
                password: "password123", 
                name: "ADRIAN TAY", 
                role: "supervisor", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["ADELINE"],
                email: "adrian.tay@archipelagogrp.com"
            },
            { 
                id: 4, 
                username: "mark", 
                password: "password123", 
                name: "MARK ANTHONY", 
                role: "supervisor", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["JAYMEE LOH", "SURIN", "MAGS"],
                email: "mark@archipelagogrp.com"
            },
            { 
                id: 5, 
                username: "farouk.aripen", 
                password: "password123", 
                name: "AHMED FAROUK", 
                role: "supervisor", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["MAGESON", "SARALA", "CHLOE", "JANE", "CHEAH GOON SENG"],
                email: "farouk.aripen@archipelagogrp.com"
            },
            { 
                id: 6, 
                username: "adeline.chong", 
                password: "password123", 
                name: "ADELINE", 
                role: "supervisor", 
                supervisor: "ADRIAN TAY", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["PRATHEBA", "SHAHRUL NIZAM"],
                email: "adeline.chong@archipelagogrp.com"
            },
            { 
                id: 7, 
                username: "jaymee.loh", 
                password: "password123", 
                name: "JAYMEE LOH", 
                role: "supervisor", 
                supervisor: "MARK ANTHONY", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["NOOR AMANINA"],
                email: "jaymee.loh@archipelagogrp.com"
            },
            { 
                id: 8, 
                username: "mike", 
                password: "password123", 
                name: "MAGESON", 
                role: "supervisor", 
                supervisor: "AHMED FAROUK", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["PREMA", "NG JOOK YEW", "NUR ALIA ZAHARAH"],
                email: "mike@archipelagogrp.com"
            },
            { 
                id: 9, 
                username: "lim.chinyee", 
                password: "password123", 
                name: "CHLOE", 
                role: "supervisor", 
                supervisor: "AHMED FAROUK", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["NURUL FADHILAH", "NUR FATIN NADIA", "FARA SHUHADA", "NORSYAFINAZ"],
                email: "lim.chinyee@archipelagogrp.com"
            },
            { 
                id: 10, 
                username: "janehuang", 
                password: "password123", 
                name: "JANE", 
                role: "supervisor", 
                supervisor: "AHMED FAROUK", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["NG YEE LING", "MOHD AKHTAR", "THIRUCHELVI", "DIANNDRE EREKA", "KEE LI KAI"],
                email: "janehuang@archipelagogrp.com"
            },
            { 
                id: 11, 
                username: "lance.cheah", 
                password: "password123", 
                name: "CHEAH GOON SENG", 
                role: "supervisor", 
                supervisor: "AHMED FAROUK", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["ASZELWIN ELSIE", "REBECCA DIANA", "JANE JULISAN", "JENNIFER LLOREN"],
                email: "lance.cheah@archipelagogrp.com"
            },
            { 
                id: 12, 
                username: "hiromi.pua", 
                password: "password123", 
                name: "PUA HOOI TENG", 
                role: "supervisor", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["SHAHIEDATUL ZHAFIRAH", "CHONG YEAN LEE", "PRISCILLA"],
                email: "hiromi.pua@archipelagogrp.com"
            },
            { 
                id: 13, 
                username: "zhafirah", 
                password: "password123", 
                name: "SHAHIEDATUL ZHAFIRAH", 
                role: "supervisor", 
                supervisor: "PUA HOOI TENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["MOHAMMAD REEZAL", "MAY", "BALQIS", "LOO KAR YONG", "JAYMEE CHYE"],
                email: "zhafirah@archipelagogrp.com"
            },
            { 
                id: 14, 
                username: "priscilla", 
                password: "password123", 
                name: "PRISCILLA", 
                role: "supervisor", 
                supervisor: "PUA HOOI TENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                manages: ["NURIN AQILAH", "HAIKAL IRFAN", "SITI HAJAR"],
                email: "priscilla@archipelagogrp.com"
            },
            // Employees
            { 
                id: 15, 
                username: "krose", 
                password: "password123", 
                name: "KROSE ANAK RAWONG", 
                role: "employee", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "krose@archipelagogrp.com"
            },
            { 
                id: 16, 
                username: "simon", 
                password: "password123", 
                name: "SIMON HARDI", 
                role: "employee", 
                supervisor: "Mr IAN", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "simon@archipelagogrp.com"
            },
            { 
                id: 17, 
                username: "surin", 
                password: "password123", 
                name: "SURIN", 
                role: "employee", 
                supervisor: "MARK ANTHONY", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "surin@archipelagogrp.com"
            },
            { 
                id: 18, 
                username: "sarala", 
                password: "password123", 
                name: "SARALA", 
                role: "employee", 
                supervisor: "AHMED FAROUK", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "sarala@archipelagogrp.com"
            },
            { 
                id: 19, 
                username: "prathebha", 
                password: "password123", 
                name: "PRATHEBA", 
                role: "employee", 
                supervisor: "ADELINE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "prathebha@archipelagogrp.com"
            },
            { 
                id: 20, 
                username: "shahrul", 
                password: "password123", 
                name: "SHAHRUL NIZAM", 
                role: "employee", 
                supervisor: "ADELINE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "shahrul@archipelagogrp.com"
            },
            { 
                id: 21, 
                username: "amanina", 
                password: "password123", 
                name: "NOOR AMANINA", 
                role: "employee", 
                supervisor: "JAYMEE LOH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "amanina@archipelagogrp.com"
            },
            { 
                id: 22, 
                username: "prema", 
                password: "password123", 
                name: "PREMA", 
                role: "employee", 
                supervisor: "MAGESON", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "prema@archipelagogrp.com"
            },
            { 
                id: 23, 
                username: "nicholas.ng", 
                password: "password123", 
                name: "NG JOOK YEW", 
                role: "employee", 
                supervisor: "MAGESON", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "nicholas.ng@archipelagogrp.com"
            },
            { 
                id: 24, 
                username: "nuraliazaharah", 
                password: "password123", 
                name: "NUR ALIA ZAHARAH", 
                role: "employee", 
                supervisor: "MAGESON", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "nuraliazaharah@archipelagogrp.com"
            },
            { 
                id: 25, 
                username: "fadhilah", 
                password: "password123", 
                name: "NURUL FADHILAH", 
                role: "employee", 
                supervisor: "CHLOE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "fadhilah@archipelagogrp.com"
            },
            { 
                id: 26, 
                username: "fatin.nadia", 
                password: "password123", 
                name: "NUR FATIN NADIA", 
                role: "employee", 
                supervisor: "CHLOE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "fatin.nadia@archipelagogrp.com"
            },
            { 
                id: 27, 
                username: "fara", 
                password: "password123", 
                name: "FARA SHUHADA", 
                role: "employee", 
                supervisor: "CHLOE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "fara@archipelagogrp.com"
            },
            { 
                id: 28, 
                username: "norsyafinaz", 
                password: "password123", 
                name: "NORSYAFINAZ", 
                role: "employee", 
                supervisor: "CHLOE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "norsyafinaz@archipelagogrp.com"
            },
            { 
                id: 29, 
                username: "yeeling.ng", 
                password: "password123", 
                name: "NG YEE LING", 
                role: "employee", 
                supervisor: "JANE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "yeeling.ng@archipelagogrp.com"
            },
            { 
                id: 30, 
                username: "akhtar", 
                password: "password123", 
                name: "MOHD AKHTAR", 
                role: "employee", 
                supervisor: "JANE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "akhtar@archipelagogrp.com"
            },
            { 
                id: 31, 
                username: "selvi", 
                password: "password123", 
                name: "THIRUCHELVI", 
                role: "employee", 
                supervisor: "JANE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "selvi@archipelagogrp.com"
            },
            { 
                id: 32, 
                username: "dianndre", 
                password: "password123", 
                name: "DIANNDRE EREKA", 
                role: "employee", 
                supervisor: "JANE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "dianndre@archipelagogrp.com"
            },
            { 
                id: 33, 
                username: "keelikai", 
                password: "password123", 
                name: "KEE LI KAI", 
                role: "employee", 
                supervisor: "JANE", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "keelikai@archipelagogrp.com"
            },
            { 
                id: 34, 
                username: "elsie", 
                password: "password123", 
                name: "ASZELWIN ELSIE", 
                role: "employee", 
                supervisor: "CHEAH GOON SENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "elsie@archipelagogrp.com"
            },
            { 
                id: 35, 
                username: "rebecca", 
                password: "password123", 
                name: "REBECCA DIANA", 
                role: "employee", 
                supervisor: "CHEAH GOON SENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "rebecca@archipelagogrp.com"
            },
            { 
                id: 36, 
                username: "jane", 
                password: "password123", 
                name: "JANE JULISAN", 
                role: "employee", 
                supervisor: "CHEAH GOON SENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "jane@archipelagogrp.com"
            },
            { 
                id: 37, 
                username: "jennifer", 
                password: "password123", 
                name: "JENNIFER LLOREN", 
                role: "employee", 
                supervisor: "CHEAH GOON SENG", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "jennifer@archipelagogrp.com"
            },
            { 
                id: 38, 
                username: "reezal", 
                password: "password123", 
                name: "MOHAMMAD REEZAL", 
                role: "employee", 
                supervisor: "SHAHIEDATUL ZHAFIRAH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "reezal@archipelagogrp.com"
            },
            { 
                id: 39, 
                username: "may.neoh", 
                password: "password123", 
                name: "MAY", 
                role: "employee", 
                supervisor: "SHAHIEDATUL ZHAFIRAH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "may.neoh@archipelagogrp.com"
            },
            { 
                id: 40, 
                username: "balqis", 
                password: "password123", 
                name: "BALQIS", 
                role: "employee", 
                supervisor: "SHAHIEDATUL ZHAFIRAH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "balqis@archipelagogrp.com"
            },
            { 
                id: 41, 
                username: "karyong", 
                password: "password123", 
                name: "LOO KAR YONG", 
                role: "employee", 
                supervisor: "SHAHIEDATUL ZHAFIRAH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "karyong@archipelagogrp.com"
            },
            { 
                id: 42, 
                username: "jaymee.chye", 
                password: "password123", 
                name: "JAYMEE CHYE", 
                role: "employee", 
                supervisor: "SHAHIEDATUL ZHAFIRAH", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "jaymee.chye@archipelagogrp.com"
            },
            { 
                id: 43, 
                username: "nurinaqilah", 
                password: "password123", 
                name: "NURIN AQILAH", 
                role: "employee", 
                supervisor: "PRISCILLA", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "nurinaqilah@archipelagogrp.com"
            },
            { 
                id: 44, 
                username: "haikal.irfan", 
                password: "password123", 
                name: "HAIKAL IRFAN", 
                role: "employee", 
                supervisor: "PRISCILLA", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "haikal.irfan@archipelagogrp.com"
            },
            { 
                id: 45, 
                username: "sitihajar", 
                password: "password123", 
                name: "SITI HAJAR", 
                role: "employee", 
                supervisor: "PRISCILLA", 
                leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                email: "sitihajar@archipelagogrp.com"
            },
        ];

        const publicHolidays = [];
        const leaveRequests = [];
        const unrecordedLeaves = [];
        const notifications = [];

        // Initialize date pickers
        flatpickr(".datepicker", {
            dateFormat: "d M Y",
            disable: [
                function(date) {
                    // Disable weekends
                    return (date.getDay() === 0 || date.getDay() === 6);
                }
            ]
        });

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const mainContent = document.getElementById('mainContent');
        const logoutBtn = document.querySelector('.logout-btn');
        const infoIcon = document.getElementById('infoIcon');
        const infoTooltip = document.getElementById('infoTooltip');
        const notificationBell = document.getElementById('notificationBell');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        // Current User
        let currentUser = null;

        // Login Functionality
        loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    // Find user
    const user = users.find(u => u.username === username && u.password === password);

    if (user) {
        currentUser = user;
        loginPage.style.display = 'none';
        dashboardPage.style.display = 'block';
        welcomeMessage.textContent = `Welcome, ${user.name} (${user.role === 'hr' ? 'HR' : user.role.charAt(0).toUpperCase() + user.role.slice(1)})`;
        loadDashboard();
        updateNotificationBadge();
    } else {
        alert('Invalid username or password');
    }
});

        // Forgot Password
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('forgotPasswordModal').style.display = 'flex';
        });

        // Forgot Password Form Submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('forgotUsername').value.trim();
            const user = users.find(u => u.username === username);
            
            if (user) {
                // In a real app, this would send an email with a password reset link
                alert(`Password reset link has been sent to ${user.email}`);
                document.getElementById('forgotPasswordModal').style.display = 'none';
            } else {
                alert('Username not found');
            }
        });

        // Logout Functionality
        logoutBtn.addEventListener('click', function() {
            currentUser = null;
            dashboardPage.style.display = 'none';
            loginPage.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
        });

        // Info icon hover
        infoIcon.addEventListener('mouseenter', function() {
            infoTooltip.style.display = 'block';
        });

        infoIcon.addEventListener('mouseleave', function() {
            infoTooltip.style.display = 'none';
        });

        // Update notification badge
        function updateNotificationBadge() {
            if (currentUser && (currentUser.role === 'supervisor' || currentUser.role === 'hr')) {
                const pendingRequests = leaveRequests.filter(req => 
                    req.status === 'pending' && 
                    (currentUser.role === 'hr' || req.approver === currentUser.name)
                );
                
                if (pendingRequests.length > 0) {
                    notificationBell.style.display = 'block';
                    notificationBadge.textContent = pendingRequests.length;
                } else {
                    notificationBell.style.display = 'none';
                }
            } else {
                notificationBell.style.display = 'none';
            }
        }

        // Toggle notification dropdown and redirect to leave requests
        notificationBell.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentUser.role === 'supervisor' || currentUser.role === 'hr') {
                loadLeaveRequestsView();
            }
        });

        // Close notification dropdown when clicking outside
        // Close modals when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
});

// Close modals when clicking close button
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
    });
});

        // Load Dashboard based on user role
        function loadDashboard() {
            // Clear previous content
            sidebarMenu.innerHTML = '';
            mainContent.innerHTML = '';

            // Common menu items
            const commonMenuItems = [
                { icon: 'fa-tachometer-alt', text: 'Dashboard', action: 'loadDashboardView' },
                { icon: 'fa-calendar-plus', text: 'Apply Leave', action: 'loadApplyLeaveView' },
                { icon: 'fa-history', text: 'Leave Requests', action: 'loadLeaveRequestsView' },
                { icon: 'fa-user-cog', text: 'Profile', action: 'loadProfileView' },
                { icon: 'fa-key', text: 'Change Password', action: 'showChangePasswordModal' }
            ];

            // Role-specific menu items
            let roleSpecificItems = [];
            if (currentUser.role === 'supervisor') {
                roleSpecificItems = [
                    { icon: 'fa-users', text: 'My Employees', action: 'loadMyEmployeesView' },
                    { icon: 'fa-calendar-day', text: 'Public Holidays', action: 'loadPublicHolidaysView' },
                    { icon: 'fa-calendar-minus', text: 'Unrecorded Leaves', action: 'loadUnrecordedLeavesView' }
                ];
            } else if (currentUser.role === 'hr') {
                roleSpecificItems = [
                    { icon: 'fa-users', text: 'Employee Management', action: 'loadEmployeeManagementView' },
                    { icon: 'fa-user-tie', text: 'Supervisor Management', action: 'loadSupervisorManagementView' },
                    { icon: 'fa-calendar-day', text: 'Public Holidays', action: 'loadPublicHolidaysView' },
                    { icon: 'fa-calendar-minus', text: 'Unrecorded Leaves', action: 'loadUnrecordedLeavesView' },
                    { icon: 'fa-trash', text: 'Deleted Employees', action: 'loadDeletedEmployeesView' },
                    { icon: 'fa-list', text: 'Employee List', action: 'loadEmployeeListView' },
                ];
            } else if (currentUser.role === 'employee') {
                roleSpecificItems = [
                    { icon: 'fa-calendar-day', text: 'Public Holidays', action: 'loadPublicHolidaysView' },
                    { icon: 'fa-calendar-minus', text: 'Unrecorded Leaves', action: 'loadUnrecordedLeavesView' }
                ];
            }

            // Create menu items
            [...commonMenuItems, ...roleSpecificItems].forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.innerHTML = `<i class="fas ${item.icon}"></i> ${item.text}`;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    window[item.action]();
                });
                li.appendChild(a);
                sidebarMenu.appendChild(li);
            });

            // Load default view
            loadDashboardView();
        }

        // View Loaders
        function loadDashboardView() {
    // Common dashboard elements for all users
    let dashboardHTML = `
        <div class="page-title">
            <h1>${currentUser.role === 'hr' ? 'HR' : currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} Dashboard</h1>
            ${currentUser.role !== 'employee' ? '<button class="btn btn-primary" id="applyLeaveBtn"><i class="fas fa-plus"></i> Apply Leave</button>' : ''}
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title">Leave Balances</h2>
                <button class="btn btn-sm btn-outline-secondary" id="toggleLeaveBalance">
                    <i class="fas fa-chevron-down"></i> Show Balances
                </button>
            </div>
            <div class="leave-balance-table" id="leaveBalanceTable" style="display:none;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Leave Type</th>
                            <th>Balance</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(currentUser.leaveBalances).map(([type, balance]) => {
                            // Properly format leave type names (remove double capitalization)
                            let formattedType = type.charAt(0).toUpperCase() + type.slice(1);
                            formattedType = formattedType.replace(/([A-Z])/g, ' $1').trim();
                            
                            return `
                                <tr>
                                    <td>${formattedType}</td>
                                    <td>${balance} ${balance === 1 ? 'day' : 'days'}</td>
                                    <td>${
                                        type === 'emergency' ? 
                                        `(Max 7 days from annual leave)` :
                                        type === 'annual' ? 
                                        `(Emergency leave available: ${Math.min(7, balance)} days)` :
                                        ''
                                    }</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // HR-specific dashboard elements
    if (currentUser.role === 'hr') {
        const pendingRequests = leaveRequests.filter(req => req.status === 'pending').length;
        
        dashboardHTML += `
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">System Overview</h2>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card p-3">
                                        <h3><i class="fas fa-users"></i></h3>
                                        <h4>${users.length}</h4>
                                        <p class="mb-0 text-muted">Employees</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card p-3">
                                        <h3><i class="fas fa-user-tie"></i></h3>
                                        <h4>${supervisors.length}</h4>
                                        <p class="mb-0 text-muted">Supervisors</p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="stat-card p-3">
                                        <h3><i class="fas fa-exclamation-circle"></i></h3>
                                        <h4>${pendingRequests}</h4>
                                        <p class="mb-0 text-muted">Pending Requests</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Leave Statistics</h2>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-6 mb-3">
                                    <div class="stat-card p-3">
                                        <h3><i class="fas fa-calendar-day"></i></h3>
                                        <h4>${publicHolidays.length}</h4>
                                        <p class="mb-0 text-muted">Public Holidays</p>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="stat-card p-3">
                                        <h3><i class="fas fa-calendar-minus"></i></h3>
                                        <h4>${unrecordedLeaves.length}</h4>
                                        <p class="mb-0 text-muted">Unrecorded Leaves</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" onclick="showManageEmployeeModal()">
                            <i class="fas fa-user-plus"></i> Add Employee
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showManageSupervisorModal()">
                            <i class="fas fa-user-tie"></i> Manage Supervisors
                        </button>
                        <button class="btn btn-outline-success" onclick="showAddHolidayModal()">
                            <i class="fas fa-calendar-plus"></i> Add Holiday
                        </button>
                        <button class="btn btn-outline-info" onclick="showAddUnrecordedLeaveModal()">
                            <i class="fas fa-calendar-minus"></i> Add Unrecorded Leave
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Set the HTML content
    mainContent.innerHTML = dashboardHTML;

    // Toggle leave balance table visibility
    document.getElementById('toggleLeaveBalance').addEventListener('click', function() {
        const table = document.getElementById('leaveBalanceTable');
        const icon = this.querySelector('i');
        if (table.style.display === 'none') {
            table.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            this.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Balances';
        } else {
            table.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            this.innerHTML = '<i class="fas fa-chevron-down"></i> Show Balances';
        }
    });

    // Apply leave button event listener
    const applyLeaveBtn = document.getElementById('applyLeaveBtn');
    if (applyLeaveBtn) {
        applyLeaveBtn.addEventListener('click', showApplyLeaveModal);
    }

    // Add minimal dynamic styles if they don't exist
    if (!document.getElementById('dashboardStyles')) {
        const style = document.createElement('style');
        style.id = 'dashboardStyles';
        style.textContent = `
            .stat-card {
                transition: all 0.2s ease;
                border: 1px solid #eee;
                border-radius: 5px;
            }
            .stat-card:hover {
                background-color: #f8f9fa;
            }
            .gap-2 {
                gap: 0.5rem;
            }
        `;
        document.head.appendChild(style);
    }
}
        function loadApplyLeaveView() {
    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Apply for Leave</h1>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">New Leave Application</h2>
            </div>
            <form id="leaveFormPage">
                <div class="form-group">
                    <label for="leaveTypePage" class="form-label">Leave Type</label>
                    <select id="leaveTypePage" class="form-select" required>
                        <option value="">Select Leave Type</option>
                        <option value="annual">Annual Leave</option>
                        <option value="emergency">Emergency Leave</option>
                        <option value="medical">Medical Leave</option>
                        <option value="marriage">Marriage Leave</option>
                        <option value="maternity">Maternity Leave (60 days)</option>
                        <option value="paternity">Paternity Leave (2 days)</option>
                        <option value="compassionate">Compassionate Leave</option>
                        <option value="study">Study Leave</option>
                        <option value="examination">Examination Leave</option>
                        <option value="replacement">Replacement Leave</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="leaveDurationPage" class="form-label">Duration</label>
                    <select id="leaveDurationPage" class="form-select" required>
                        <option value="">Select Duration</option>
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                        <option value="multiple">Multiple Days</option>
                    </select>
                </div>

                <div class="form-group" id="halfDayGroupPage" style="display: none;">
                    <label for="halfDayTimePage" class="form-label">Half Day Time</label>
                    <select id="halfDayTimePage" class="form-select">
                        <option value="morning">Morning</option>
                        <option value="afternoon">Afternoon</option>
                    </select>
                </div>

                <div class="form-group" id="singleDateGroupPage">
                    <label for="leaveDatePage" class="form-label">Date</label>
                    <input type="text" id="leaveDatePage" class="form-control datepicker" placeholder="Select date" required>
                </div>

                <div class="form-group" id="dateRangeGroupPage" style="display: none;">
                    <label for="leaveStartDatePage" class="form-label">Start Date</label>
                    <input type="text" id="leaveStartDatePage" class="form-control datepicker" placeholder="Select start date">

                    <label for="leaveEndDatePage" class="form-label" style="margin-top: 10px;">End Date</label>
                    <input type="text" id="leaveEndDatePage" class="form-control datepicker" placeholder="Select end date">
                </div>

                <div class="form-group">
                    <label for="leaveRemarkPage" class="form-label">Remark</label>
                    <textarea id="leaveRemarkPage" class="form-control" rows="3" placeholder="Enter remark for leave" required></textarea>
                </div>

                <div class="form-group" id="documentUploadGroupPage" style="display: none;">
                    <label for="leaveDocumentPage" class="form-label">Supporting Document</label>
                    <input type="file" id="leaveDocumentPage" class="form-control" accept=".pdf,.jpg,.jpeg">
                    <small class="text-muted">Required for all leave types except Annual and Emergency Leave</small>
                </div>

                <div class="form-group">
                    <label for="contactNumberPage" class="form-label">Contact Number During Leave</label>
                    <input type="tel" id="contactNumberPage" class="form-control" placeholder="Enter contact number (optional)">
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Submit Application</button>
                </div>
            </form>
        </div>
    `;

    // Initialize date pickers with disabled dates
    const disabledDates = getDisabledDates();
    
    flatpickr("#leaveDatePage", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveStartDatePage", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveEndDatePage", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    // Event listeners for form elements
    document.getElementById('leaveDurationPage').addEventListener('change', function() {
        const duration = this.value;
        const singleDateGroup = document.getElementById('singleDateGroupPage');
        const dateRangeGroup = document.getElementById('dateRangeGroupPage');
        const halfDayGroup = document.getElementById('halfDayGroupPage');

        if (duration === 'multiple') {
            singleDateGroup.style.display = 'none';
            dateRangeGroup.style.display = 'block';
            halfDayGroup.style.display = 'none';
        } else if (duration === 'half') {
            singleDateGroup.style.display = 'block';
            dateRangeGroup.style.display = 'none';
            halfDayGroup.style.display = 'block';
        } else {
            singleDateGroup.style.display = 'block';
            dateRangeGroup.style.display = 'none';
            halfDayGroup.style.display = 'none';
        }
    });

    document.getElementById('leaveTypePage').addEventListener('change', function() {
        const leaveType = this.value;
        const documentUploadGroup = document.getElementById('documentUploadGroupPage');

        if (leaveType === 'annual' || leaveType === 'emergency') {
            documentUploadGroup.style.display = 'none';
        } else {
            documentUploadGroup.style.display = 'block';
        }
    });

    // Form submission
    document.getElementById('leaveFormPage').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const leaveType = document.getElementById('leaveTypePage').value;
        const duration = document.getElementById('leaveDurationPage').value;
        const halfDayTime = duration === 'half' ? document.getElementById('halfDayTimePage').value : null;
        const startDate = duration === 'multiple' ? document.getElementById('leaveStartDatePage').value : document.getElementById('leaveDatePage').value;
        const endDate = duration === 'multiple' ? document.getElementById('leaveEndDatePage').value : document.getElementById('leaveDatePage').value;
        const remark = document.getElementById('leaveRemarkPage').value;
        const documentFile = document.getElementById('leaveDocumentPage').files[0] ? document.getElementById('leaveDocumentPage').files[0].name : null;
        const contactNumber = document.getElementById('contactNumberPage').value;
        
        // Calculate duration in days excluding weekends and holidays
        let days = 0;
        if (duration === 'multiple') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                // Skip weekends
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                // Skip public holidays
                const isHoliday = publicHolidays.some(holiday => {
                    const holidayDate = new Date(holiday.date);
                    return holidayDate.toDateString() === date.toDateString();
                });
                if (isHoliday) continue;
                
                // Skip unrecorded leaves
                const isUnrecordedLeave = unrecordedLeaves.some(leave => {
                    const leaveDate = new Date(leave.date);
                    return leaveDate.toDateString() === date.toDateString() && 
                          (leave.scope === 'all' || (leave.scope === 'selected' && leave.employees.includes(currentUser.id)));
                });
                if (isUnrecordedLeave) continue;
                
                days += 1;
            }
        } else if (duration === 'half') {
            days = 0.5;
        } else {
            days = 1;
        }
        
        // Find the approver - HR requests go to Mark Anthony
        let approver = null;
        if (currentUser.role === 'employee') {
            approver = users.find(u => u.manages && u.manages.includes(currentUser.name));
        } else if (currentUser.role === 'hr') {
            approver = users.find(u => u.name === "MARK ANTHONY");
        }
        
        // Create leave request
        const newRequest = {
            id: leaveRequests.length + 1,
            employee: currentUser.name,
            type: leaveType,
            startDate: startDate,
            endDate: endDate,
            duration: days,
            halfDayTime: halfDayTime,
            remark: remark,
            document: documentFile,
            contactNumber: contactNumber,
            status: 'pending',
            approver: approver ? approver.name : null,
            supervisor: currentUser.supervisor,
            dateApplied: new Date().toISOString().split('T')[0],
            employeeId: currentUser.id
        };
        
        leaveRequests.push(newRequest);
        
        // Send email notification
        sendLeaveApplicationEmail(newRequest);
        
        alert('Leave application submitted successfully!');
        loadDashboardView();
        updateNotificationBadge();
    });
}

function getDisabledDates() {
    const disabledDates = [];
    
    // Disable weekends
    disabledDates.push(function(date) {
        return (date.getDay() === 0 || date.getDay() === 6);
    });

    // Disable public holidays
    publicHolidays.forEach(holiday => {
        const date = new Date(holiday.date);
        disabledDates.push({
            from: date,
            to: date
        });
    });

    // Disable unrecorded leaves that apply to current user
    unrecordedLeaves.forEach(leave => {
        if (leave.scope === 'all' || (leave.scope === 'selected' && leave.employees.includes(currentUser.id))) {
            const date = new Date(leave.date);
            disabledDates.push({
                from: date,
                to: date
            });
        }
    });

    return disabledDates;
}

function showApplyLeaveModal() {
    const modal = document.getElementById('applyLeaveModal');
    modal.style.display = 'flex';
    
    // Reset form
    document.getElementById('leaveForm').reset();
    document.getElementById('leaveForm').dataset.modifying = '';
    document.getElementById('halfDayGroup').style.display = 'none';
    document.getElementById('dateRangeGroup').style.display = 'none';
    document.getElementById('singleDateGroup').style.display = 'block';
    document.getElementById('documentUploadGroup').style.display = 'none';
    
    // Initialize date pickers with disabled dates
    const disabledDates = getDisabledDates();
    
    flatpickr("#leaveDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveStartDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveEndDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });
    
    // Event listeners for form elements
    document.getElementById('leaveDuration').addEventListener('change', function() {
        const duration = this.value;
        document.getElementById('singleDateGroup').style.display = duration === 'multiple' ? 'none' : 'block';
        document.getElementById('dateRangeGroup').style.display = duration === 'multiple' ? 'block' : 'none';
        document.getElementById('halfDayGroup').style.display = duration === 'half' ? 'block' : 'none';
    });
    
    document.getElementById('leaveType').addEventListener('change', function() {
        const leaveType = this.value;
        document.getElementById('documentUploadGroup').style.display = 
            (leaveType === 'annual' || leaveType === 'emergency') ? 'none' : 'block';
    });
    
    // Form submission
    document.getElementById('leaveForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const leaveType = document.getElementById('leaveType').value;
        const duration = document.getElementById('leaveDuration').value;
        const halfDayTime = duration === 'half' ? document.getElementById('halfDayTime').value : null;
        const startDate = duration === 'multiple' ? document.getElementById('leaveStartDate').value : document.getElementById('leaveDate').value;
        const endDate = duration === 'multiple' ? document.getElementById('leaveEndDate').value : document.getElementById('leaveDate').value;
        const remark = document.getElementById('leaveRemark').value;
        const document = document.getElementById('leaveDocument').files[0] ? document.getElementById('leaveDocument').files[0].name : null;
        const contactNumber = document.getElementById('contactNumber').value;
        
        // Calculate duration in days excluding weekends and holidays
        let days = calculateLeaveDuration(startDate, endDate, duration);
        
        // Check if we're modifying an existing request
        const modifyingId = document.getElementById('leaveForm').dataset.modifying;
        
        if (modifyingId) {
            // Update existing request
            const request = leaveRequests.find(req => req.id === parseInt(modifyingId));
            if (request) {
                // If previously approved, restore the leave balance
                if (request.status === 'approved') {
                    const user = users.find(u => u.id === request.employeeId);
                    if (user) {
                        if (request.type === 'emergency') {
                            user.leaveBalances.annual += request.duration;
                            user.leaveBalances.emergency += request.duration;
                        } else if (request.type === 'annual') {
                            user.leaveBalances.annual += request.duration;
                        } else {
                            user.leaveBalances[request.type] += request.duration;
                        }
                    }
                }
                
                // Update request details
                request.type = leaveType;
                request.startDate = startDate;
                request.endDate = endDate;
                request.duration = days;
                request.halfDayTime = halfDayTime;
                request.remark = remark;
                request.document = document;
                request.contactNumber = contactNumber;
                request.status = 'pending'; // Reset status for re-approval
                
                alert('Leave application modified successfully!');
            }
        } else {
            // Create new request
            const newRequest = {
                id: leaveRequests.length + 1,
                employee: currentUser.name,
                type: leaveType,
                startDate: startDate,
                endDate: endDate,
                duration: days,
                halfDayTime: halfDayTime,
                remark: remark,
                document: document,
                contactNumber: contactNumber,
                status: 'pending',
                approver: currentUser.role === 'employee' ? 
                    (users.find(u => u.manages && u.manages.includes(currentUser.name))?.name || null) : 
                    (currentUser.role === 'hr' ? "MARK ANTHONY" : null),
                supervisor: currentUser.supervisor,
                dateApplied: new Date().toISOString().split('T')[0],
                employeeId: currentUser.id
            };
            
            leaveRequests.push(newRequest);
            alert('Leave application submitted successfully!');
        }
        
        modal.style.display = 'none';
        loadDashboardView();
        updateNotificationBadge();
    });
}

function calculateLeaveDuration(startDate, endDate, duration) {
    if (duration === 'half') return 0.5;
    if (duration === 'full') return 1;
    
    let days = 0;
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
        // Skip weekends
        if (date.getDay() === 0 || date.getDay() === 6) continue;
        
        // Skip public holidays
        const isHoliday = publicHolidays.some(holiday => {
            const holidayDate = new Date(holiday.date);
            return holidayDate.toDateString() === date.toDateString();
        });
        if (isHoliday) continue;
        
        // Skip unrecorded leaves
        const isUnrecordedLeave = unrecordedLeaves.some(leave => {
            const leaveDate = new Date(leave.date);
            return leaveDate.toDateString() === date.toDateString() && 
                  (leave.scope === 'all' || (leave.scope === 'selected' && leave.employees.includes(currentUser.id)));
        });
        if (isUnrecordedLeave) continue;
        
        days += 1;
    }
    
    return days;
}

function showApplyLeaveModal() {
    const modal = document.getElementById('applyLeaveModal');
    modal.style.display = 'flex';
    
    // Reset form
    document.getElementById('leaveForm').reset();
    
    // Initialize date pickers with disabled dates
    const disabledDates = getDisabledDates();
    
    flatpickr("#leaveDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveStartDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });

    flatpickr("#leaveEndDate", {
        dateFormat: "d M Y",
        disable: disabledDates
    });
    
    // Rest of the modal initialization code...
}

function loadLeaveRequestsView() {
    // Filter leave requests based on user role
    let userLeaves = [];
    if (currentUser.role === 'employee') {
        userLeaves = leaveRequests.filter(req => req.employeeId === currentUser.id);
    } else if (currentUser.role === 'supervisor') {
        userLeaves = leaveRequests.filter(req => 
            (req.approver === currentUser.name || req.employeeId === currentUser.id)
        );
    } else if (currentUser.role === 'hr') {
        userLeaves = [...leaveRequests];
    }
    
    // Separate pending and processed requests
    const pendingRequests = userLeaves.filter(req => req.status === 'pending');
    const processedRequests = userLeaves.filter(req => req.status !== 'pending');

    // Main HTML structure
    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Leave Requests</h1>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="pending">Pending Requests (${pendingRequests.length})</div>
            <div class="tab" data-tab="processed">Processed Requests (${processedRequests.length})</div>
        </div>
        
        <div class="tab-content active" id="pendingTab">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Pending Leave Requests</h2>
                </div>
                <div class="table-responsive">
                    <table class="table" id="leaveRequestsTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Leave Type</th>
                                <th>Dates</th>
                                <th>Duration</th>
                                <th>Remark</th>
                                <th>Document</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingRequests.length > 0 ? 
                                pendingRequests.map(req => `
                                    <tr>
                                        <td>${req.employee}</td>
                                        <td>${req.type.charAt(0).toUpperCase() + req.type.slice(1)} Leave</td>
                                        <td>${formatDate(req.startDate)} ${req.duration === 0.5 ? `(${req.halfDayTime})` : req.startDate !== req.endDate ? `- ${formatDate(req.endDate)}` : ''}</td>
                                        <td>${req.duration} ${req.duration === 1 ? 'day' : 'days'}</td>
                                        <td>${req.remark}</td>
                                        <td>${req.document ? `<a href="#" onclick="viewDocument('${req.document}')">View</a>` : 'None'}</td>
                                        <td><span class="badge badge-warning">Pending</span></td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-info" onclick="viewLeaveDetails(${req.id})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                ${(currentUser.role === 'hr' || req.approver === currentUser.name) ? `
                                                <button class="btn btn-sm btn-success" onclick="approveLeave(${req.id})">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="showRejectLeaveModal(${req.id})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                ` : ''}
                                                ${currentUser.id === req.employeeId ? `
                                                <button class="btn btn-sm btn-warning" onclick="modifyLeaveRequest(${req.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="cancelLeaveRequest(${req.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') : `
                                <tr>
                                    <td colspan="8" class="text-center">No pending leave requests</td>
                                </tr>
                                `}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="processedTab">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Processed Leave Requests</h2>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Leave Type</th>
                                <th>Dates</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${processedRequests.length > 0 ? 
                                processedRequests.map(req => `
                                    <tr>
                                        <td>${req.employee}</td>
                                        <td>${req.type.charAt(0).toUpperCase() + req.type.slice(1)} Leave</td>
                                        <td>${formatDate(req.startDate)} ${req.duration === 0.5 ? `(${req.halfDayTime})` : req.startDate !== req.endDate ? `- ${formatDate(req.endDate)}` : ''}</td>
                                        <td>${req.duration} ${req.duration === 1 ? 'day' : 'days'}</td>
                                        <td><span class="badge ${getStatusBadgeClass(req.status)}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span></td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-info" onclick="viewLeaveDetails(${req.id})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                ${(currentUser.role === 'hr' || req.approver === currentUser.name) && req.status !== 'rejected' ? `
                                                <button class="btn btn-sm btn-danger" onclick="showRejectLeaveModal(${req.id})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') : `
                                <tr>
                                    <td colspan="6" class="text-center">No processed leave requests</td>
                                </tr>
                                `}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Add tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(`${this.dataset.tab}Tab`).classList.add('active');
        });
    });

    // Add styles for the action buttons if they don't exist
    if (!document.getElementById('leaveRequestStyles')) {
        const style = document.createElement('style');
        style.id = 'leaveRequestStyles';
        style.textContent = `
            .d-flex.gap-1 {
                display: flex;
                gap: 0.25rem;
            }
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
        `;
        document.head.appendChild(style);
    }
}
        function loadMyEmployeesView() {
            if (currentUser.role !== 'supervisor') return;

            mainContent.innerHTML = `
                <div class="page-title">
                    <h1>My Employees</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Employee List</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Supervisor</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.filter(u => currentUser.manages.includes(u.name)).map(user => `
                                    <tr>
                                        <td>${user.name}</td>
                                        <td>${user.supervisor}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="viewEmployeeDetails(${user.id})"><i class="fas fa-eye"></i> View</button>
                                            <button class="btn btn-sm btn-info" onclick="viewLeaveBalance(${user.id})"><i class="fas fa-calendar"></i> Leave Balance</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadPublicHolidaysView() {
            mainContent.innerHTML = `
                <div class="page-title">
                    <h1>Public Holidays</h1>
                    ${currentUser.role === 'hr' ? '<button class="btn btn-primary" onclick="showAddHolidayModal()"><i class="fas fa-plus"></i> Add Holiday</button>' : ''}
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Upcoming Holidays</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    ${currentUser.role === 'hr' ? '<th>Actions</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${publicHolidays.length > 0 ? 
                                    publicHolidays.map(holiday => `
                                        <tr>
                                            <td>${holiday.name}</td>
                                            <td>${formatDate(holiday.date)}</td>
                                            <td>${holiday.duration === 'full' ? 'Full Day' : 'Half Day'} ${holiday.duration === 'half' ? `(${holiday.halfDayTime})` : ''}</td>
                                            ${currentUser.role === 'hr' ? `
                                        
                                            <td>
                                                <button class="btn btn-sm btn-danger" onclick="deleteHoliday(${holiday.id})"><i class="fas fa-trash"></i> Delete</button>
                                            </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                    <tr>
                                        <td colspan="${currentUser.role === 'hr' ? '4' : '3'}" style="text-align: center;">No public holidays added</td>
                                    </tr>
                                    `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadUnrecordedLeavesView() {
            mainContent.innerHTML = `
                <div class="page-title">
                    <h1>Unrecorded Leaves</h1>
                    ${currentUser.role === 'hr' ? '<button class="btn btn-primary" onclick="showAddUnrecordedLeaveModal()"><i class="fas fa-plus"></i> Add Unrecorded Leave</button>' : ''}
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Unrecorded Leave History</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Applied To</th>
                                    ${currentUser.role === 'hr' ? '<th>Actions</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${unrecordedLeaves.length > 0 ? 
                                    unrecordedLeaves
                                    .filter(leave => 
                                        currentUser.role === 'hr' || 
                                        leave.scope === 'all' || 
                                        (leave.scope === 'selected' && leave.employees.includes(currentUser.id))
                                    )
                                    .map(leave => {
                                        let appliedTo = leave.scope === 'all' ? 'All Employees' : 'Selected Employees';
                                        if (currentUser.role === 'hr' && leave.scope === 'selected') {
                                            const selectedNames = leave.employees.map(id => {
                                                const user = users.find(u => u.id === id);
                                                return user ? user.name : '';
                                            }).filter(name => name !== '');
                                            appliedTo = selectedNames.join(', ');
                                            const unrecordedLeaves = [
    { id: 1, name: "Company Retreat", date: "2023-06-15", scope: "all" },
    // ...
];

                                        }
                                        return `
                                        <tr>
                                            <td>${leave.name}</td>
                                            <td>${formatDate(leave.date)}</td>
                                            <td>${leave.duration === 'full' ? 'Full Day' : 'Half Day'} ${leave.duration === 'half' ? `(${leave.halfDayTime})` : ''}</td>
                                            <td>${appliedTo}</td>
                                            ${currentUser.role === 'hr' ? `
                                            <td>
                                                <button class="btn btn-sm btn-danger" onclick="deleteUnrecordedLeave(${leave.id})"><i class="fas fa-trash"></i> Delete</button>
                                            </td>
                                            ` : ''}
                                        </tr>
                                    `}).join('') : `
                                    <tr>
                                        <td colspan="${currentUser.role === 'hr' ? '5' : '4'}" style="text-align: center;">No unrecorded leaves added</td>
                                    </tr>
                                    `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadEmployeeManagementView() {
    if (currentUser.role !== 'hr') return;

    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Employee Management</h1>
            <button class="btn btn-primary" onclick="showManageEmployeeModal()">
                <i class="fas fa-plus"></i> Add Employee
            </button>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Employee Details</h2>
            </div>
            <div class="form-group">
                <label for="supervisorFilter" class="form-label">Filter by Supervisor</label>
                <select id="supervisorFilter" class="form-select">
                    <option value="">All Supervisors</option>
                    ${supervisors.map(sup => `
                        <option value="${sup.id}">${sup.name}</option>
                    `).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="employeeToView" class="form-label">Select Employee</label>
                <select id="employeeToView" class="form-select">
                    <option value="">-- Select an employee --</option>
                    ${users.filter(u => u.role !== 'hr').map(user => `
                        <option value="${user.id}">${user.name} (${user.supervisor})</option>
                    `).join('')}
                </select>
            </div>
            <div id="employeeDetailsContainer" style="margin-top: 20px;">
                <!-- Employee details will be loaded here -->
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-info" id="editLeaveBalanceBtn" style="display: none;">
                    <i class="fas fa-edit"></i> Edit Leave Balance
                </button>
            </div>
        </div>
    `;

    // Add event listener for supervisor filter
    document.getElementById('supervisorFilter').addEventListener('change', function() {
        const supervisorId = parseInt(this.value);
        const employeeSelect = document.getElementById('employeeToView');
        
        if (supervisorId) {
            const supervisor = supervisors.find(s => s.id === supervisorId);
            employeeSelect.innerHTML = `
                <option value="">-- Select an employee --</option>
                ${users.filter(u => u.supervisor === supervisor.name).map(user => `
                    <option value="${user.id}">${user.name}</option>
                `).join('')}
            `;
        } else {
            employeeSelect.innerHTML = `
                <option value="">-- Select an employee --</option>
                ${users.filter(u => u.role !== 'hr').map(user => `
                    <option value="${user.id}">${user.name} (${user.supervisor})</option>
                `).join('')}
            `;
        }
        
        document.getElementById('employeeDetailsContainer').innerHTML = '';
        document.getElementById('editLeaveBalanceBtn').style.display = 'none';
    });

    // Add event listener for employee selection
    document.getElementById('employeeToView').addEventListener('change', function() {
        const employeeId = parseInt(this.value);
        const editBtn = document.getElementById('editLeaveBalanceBtn');
        
        if (employeeId) {
            viewEmployeeDetails(employeeId, 'employeeDetailsContainer');
            editBtn.style.display = 'block';
            editBtn.onclick = function() { editEmployeeLeaveBalance(employeeId); };
        } else {
            document.getElementById('employeeDetailsContainer').innerHTML = '';
            editBtn.style.display = 'none';
        }
    });
}
        function loadSupervisorManagementView() {
            if (currentUser.role !== 'hr') return;

            mainContent.innerHTML = `
                <div class="page-title">
                    <h1>Supervisor Management</h1>
                    <button class="btn btn-primary" onclick="showManageSupervisorModal()"><i class="fas fa-plus"></i> Add Supervisor</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Supervisors</h2>
                    </div>
                    <div class="form-group">
                        <label for="supervisorToManage" class="form-label">Select Supervisor to Manage</label>
                        <select id="supervisorToManage" class="form-select">
                            <option value="">Select a supervisor</option>
                            ${supervisors.map(sup => `
                                <option value="${sup.id}">${sup.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div id="supervisorManagementContent" style="margin-top: 20px;">
                        <!-- Supervisor details will be loaded here -->
                    </div>
                </div>
            `;

            // Add event listener for supervisor selection
            document.getElementById('supervisorToManage').addEventListener('change', function() {
                const supId = parseInt(this.value);
                if (supId) {
                    const sup = supervisors.find(s => s.id === supId);
                    if (sup) {
                        document.getElementById('supervisorManagementContent').innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">${sup.name} Supervisor</h3>
                                </div>
                                <div style="text-align: right; margin-top: 20px;">
                                    <button class="btn btn-danger" onclick="deleteSupervisor(${sup.id})"><i class="fas fa-trash"></i> Delete Supervisor</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('supervisorManagementContent').innerHTML = '';
                }
            });
        }

        function loadProfileView() {
    mainContent.innerHTML = `
        <div class="page-title">
            <h1>My Profile</h1>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Personal Information</h2>
            </div>
            <div style="display: flex; gap: 20px; padding: 20px;">
                <div>
                    <div style="width: 150px; height: 150px; border-radius: 50%; background-color: #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${currentUser.profilePic ? 
                            `<img src="${currentUser.profilePic}" style="width: 100%; height: 100%; object-fit: cover;">` :
                            `<i class="fas fa-user" style="font-size: 60px; color: #777;"></i>`
                        }
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('profilePicUpload').click()">
                            <i class="fas fa-upload"></i> Upload Photo
                        </button>
                    </div>
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: var(--primary); margin-bottom: 5px;">${currentUser.name}</h3>
                        <p style="color: var(--gray);">${formatRoleDisplay(currentUser.role)}</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Username:</strong> ${currentUser.username}</p>
                            <p><strong>Supervisor:</strong> ${currentUser.supervisor}</p>
                            <p><strong>Email:</strong> ${currentUser.email || 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>Department:</strong> ${currentUser.department || 'N/A'}</p>
                            <p><strong>Position:</strong> ${currentUser.position || 'N/A'}</p>
                            <p><strong>Join Date:</strong> ${currentUser.joinDate || 'N/A'}</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-warning" onclick="editEmployeeDetails(${currentUser.id})">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button class="btn btn-primary" onclick="showChangePasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add helper function to format role display
    function formatRoleDisplay(role) {
    switch(role) {
        case 'hr': return 'HR';  // Changed from 'hr' to 'HR'
        case 'supervisor': return 'Supervisor';
        case 'employee': return 'Employee';
        default: return role.charAt(0).toUpperCase() + role.slice(1);
    }
}

    // Add event listener for profile picture upload
    document.getElementById('profilePicUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                currentUser.profilePic = event.target.result;
                loadProfileView();
            };
            reader.readAsDataURL(file);
        }
    });
}

        function showChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'flex';

            // Reset form
            document.getElementById('changePasswordForm').reset();
            document.getElementById('savePasswordBtn').disabled = true;

            // Reset requirements
            document.querySelectorAll('.requirement').forEach(req => {
                req.classList.remove('valid');
                req.classList.add('invalid');
                req.querySelector('i').className = 'far fa-circle';
            });

            document.getElementById('passwordMatch').textContent = '';
        }

        function showRejectLeaveModal(leaveId) {
            const modal = document.getElementById('rejectLeaveModal');
            document.getElementById('rejectLeaveId').value = leaveId;
            modal.style.display = 'flex';
        }

        function viewLeaveDetails(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    const modal = document.createElement('div');
    modal.id = 'viewLeaveModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Leave Request Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h5>Employee</h5>
                            <p>${request.employee}</p>
                        </div>
                        <div class="detail-item">
                            <h5>Leave Type</h5>
                            <p>${request.type.charAt(0).toUpperCase() + request.type.slice(1)} Leave</p>
                        </div>
                        <div class="detail-item">
                            <h5>Dates</h5>
                            <p>${formatDate(request.startDate)} ${request.duration === 0.5 ? `(${request.halfDayTime})` : request.startDate !== request.endDate ? `to ${formatDate(request.endDate)}` : ''}</p>
                        </div>
                        <div class="detail-item">
                            <h5>Duration</h5>
                            <p>${request.duration} ${request.duration === 1 ? 'day' : 'days'}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h5>Status</h5>
                            <p><span class="badge ${getStatusBadgeClass(request.status)}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></p>
                        </div>
                        <div class="detail-item">
                            <h5>Applied On</h5>
                            <p>${formatDate(request.dateApplied)}</p>
                        </div>
                        ${request.approver ? `
                        <div class="detail-item">
                            <h5>Approver</h5>
                            <p>${request.approver}</p>
                        </div>
                        ` : ''}
                        ${request.rejectRemark ? `
                        <div class="detail-item">
                            <h5>Rejection Reason</h5>
                            <p>${request.rejectRemark}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="detail-item">
                    <h5>Remark</h5>
                    <p>${request.remark}</p>
                </div>
                ${request.document ? `
                <div class="detail-item">
                    <h5>Document</h5>
                    <button class="btn btn-sm btn-info" onclick="viewDocument('${request.document}')">
                        <i class="fas fa-file-alt"></i> View Document
                    </button>
                </div>
                ` : ''}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    // Close modal functionality
    modal.querySelector('.close-modal').addEventListener('click', function() {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.removeChild(modal);
        }
    });

    // Add styles for the modal if they don't exist
    if (!document.getElementById('leaveDetailsStyles')) {
        const style = document.createElement('style');
        style.id = 'leaveDetailsStyles';
        style.textContent = `
            .detail-item {
                margin-bottom: 1rem;
            }
            .detail-item h5 {
                color: #6c757d;
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            .detail-item p {
                font-size: 1rem;
                margin-bottom: 0;
            }
        `;
        document.head.appendChild(style);
    }
}
function changeLeaveStatus(leaveId, newStatus) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    if (newStatus === 'rejected' && !request.rejectRemark) {
        // Show reject modal if rejecting without a remark
        showRejectLeaveModal(leaveId);
        return;
    }

    request.status = newStatus;
    
    if (newStatus === 'approved') {
        // Update leave balances if approving
        const user = users.find(u => u.id === request.employeeId);
        if (user) {
            if (request.type === 'emergency') {
                user.leaveBalances.annual -= request.duration;
                user.leaveBalances.emergency -= request.duration;
                user.leaveBalances.emergency = Math.max(0, Math.min(7, user.leaveBalances.emergency));
            } 
            else if (request.type === 'annual') {
                user.leaveBalances.annual -= request.duration;
                user.leaveBalances.emergency = Math.min(7, user.leaveBalances.annual);
            } 
            else {
                user.leaveBalances[request.type] -= request.duration;
            }
        }
    } else if (newStatus === 'rejected' && request.status === 'approved') {
        // Restore leave balances if rejecting a previously approved request
        const user = users.find(u => u.id === request.employeeId);
        if (user) {
            if (request.type === 'emergency') {
                user.leaveBalances.annual += request.duration;
                user.leaveBalances.emergency += request.duration;
                user.leaveBalances.emergency = Math.max(0, Math.min(7, user.leaveBalances.emergency));
            } 
            else if (request.type === 'annual') {
                user.leaveBalances.annual += request.duration;
                user.leaveBalances.emergency = Math.min(7, user.leaveBalances.annual);
            } 
            else {
                user.leaveBalances[request.type] += request.duration;
            }
        }
    }

    sendLeaveStatusEmail(request);
    alert(`Leave request ${newStatus}`);
    
    // Close the modal and refresh
    const modal = document.getElementById('viewLeaveModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
    loadLeaveRequestsView();
    updateNotificationBadge();
}

function modifyLeaveRequest(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    if (confirm('Modifying this leave will require re-approval. Continue?')) {
        showApplyLeaveModal();
        
        // Pre-fill the form with existing data
        document.getElementById('leaveType').value = request.type;
        document.getElementById('leaveDuration').value = request.duration === 0.5 ? 'half' : 
                                                        request.startDate !== request.endDate ? 'multiple' : 'full';
        
        if (request.duration === 0.5) {
            document.getElementById('halfDayTime').value = request.halfDayTime;
            document.getElementById('halfDayGroup').style.display = 'block';
        }
        
        if (request.startDate !== request.endDate) {
            document.getElementById('dateRangeGroup').style.display = 'block';
            document.getElementById('singleDateGroup').style.display = 'none';
            document.getElementById('leaveStartDate').value = request.startDate;
            document.getElementById('leaveEndDate').value = request.endDate;
        } else {
            document.getElementById('leaveDate').value = request.startDate;
        }
        
        document.getElementById('leaveRemark').value = request.remark;
        document.getElementById('contactNumber').value = request.contactNumber || '';
        
        // Mark this as a modification
        document.getElementById('leaveForm').dataset.modifying = leaveId;
        
        // Close the details modal if open
        const modal = document.getElementById('viewLeaveModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.removeChild(modal);
        }
    }
}

        function viewEmployeeDetails(userId, containerId = 'employeeDetailsContent') {
    // Find the user in the users array
    const user = users.find(u => u.id === userId);
    if (!user) {
        console.error('User not found with ID:', userId);
        return;
    }

    // Get the container where we'll display the details
    const content = document.getElementById(containerId);
    if (!content) {
        console.error('Container not found with ID:', containerId);
        return;
    }

    // Generate the HTML content
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">${user.name}'s Details</h3>
            </div>
            <div class="employee-details-container">
                <div class="employee-profile-section">
                    <div class="employee-avatar">
                        ${user.profilePic ? 
                            `<img src="${user.profilePic}" alt="${user.name}'s profile picture">` :
                            `<i class="fas fa-user default-avatar"></i>`
                        }
                    </div>
                    <div class="employee-info">
                        <div class="employee-info-grid">
                            <div class="info-column">
                                <p><strong>Username:</strong> ${user.username}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Supervisor:</strong> ${user.supervisor}</p>
                                <p><strong>Role:</strong> ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                            </div>
                            <div class="info-column">
                                <p><strong>Department:</strong> ${user.department || 'N/A'}</p>
                                <p><strong>Position:</strong> ${user.position || 'N/A'}</p>
                                <p><strong>Join Date:</strong> ${user.joinDate || 'N/A'}</p>
                                <p><strong>Status:</strong> Active</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="employee-actions">
                    <button class="btn btn-primary" onclick="editEmployeeDetails(${user.id})">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                    <button class="btn btn-info" onclick="viewLeaveBalance(${user.id})">
                        <i class="fas fa-calendar"></i> Leave Balance
                    </button>
                    ${currentUser.role === 'hr' ? `
                    <button class="btn btn-danger" onclick="deleteEmployee(${user.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    // If called from modal, show the modal
    if (containerId === 'employeeDetailsContent') {
        const modal = document.getElementById('viewEmployeeModal');
        if (modal) {
            modal.style.display = 'flex';
        } else {
            console.error('Employee details modal not found');
        }
    }

    // Add some basic styles if they don't exist
    addEmployeeDetailsStyles();
}

// Helper function to add styles for the employee details
function addEmployeeDetailsStyles() {
    if (!document.getElementById('employeeDetailsStyles')) {
        const style = document.createElement('style');
        style.id = 'employeeDetailsStyles';
        style.textContent = `
            .employee-details-container {
                padding: 20px;
            }
            .employee-profile-section {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }
            .employee-avatar {
                width: 150px;
                height: 150px;
                border-radius: 50%;
                background-color: #ddd;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            .employee-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .default-avatar {
                font-size: 60px;
                color: #777;
            }
            .employee-info {
                flex: 1;
            }
            .employee-info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .info-column p {
                margin: 5px 0;
            }
            .employee-actions {
                margin-top: 20px;
                display: flex;
                gap: 10px;
            }
        `;
        document.head.appendChild(style);
    }
}

function updateAffectedLeaveRequests(date) {
    leaveRequests.forEach(request => {
        if (request.status === 'approved') {
            const start = new Date(request.startDate);
            const end = new Date(request.endDate);
            const holidayDate = new Date(date);
            
            // Check if the holiday falls within the leave period
            if (holidayDate >= start && holidayDate <= end) {
                const user = users.find(u => u.id === request.employeeId);
                if (user) {
                    // Restore 1 day of leave
                    if (request.type === 'emergency') {
                        user.leaveBalances.annual += 1;
                        user.leaveBalances.emergency += 1;
                    } else if (request.type === 'annual') {
                        user.leaveBalances.annual += 1;
                    } else {
                        user.leaveBalances[request.type] += 1;
                    }
                    
                    // Reduce the duration by 1 day
                    request.duration -= 1;
                }
            }
        }
    });
}

function showAddHolidayModal() {
    const modal = document.getElementById('addHolidayModal');
    modal.style.display = 'flex';
    document.getElementById('holidayForm').reset();
    document.getElementById('holidayHalfDayGroup').style.display = 'none';
    
    // Initialize date picker
    flatpickr("#holidayDate", {
        dateFormat: "d M Y"
    });
    
    // Add event listener for duration change
    document.getElementById('holidayDuration').addEventListener('change', function() {
        const duration = this.value;
        document.getElementById('holidayHalfDayGroup').style.display = duration === 'half' ? 'block' : 'none';
    });
    
    // Form submission
    document.getElementById('holidayForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('holidayName').value;
        const date = document.getElementById('holidayDate').value;
        const duration = document.getElementById('holidayDuration').value;
        const halfDayTime = duration === 'half' ? document.getElementById('holidayHalfDayTime').value : null;

        // Add holiday
        publicHolidays.push({
            id: publicHolidays.length + 1,
            name,
            date,
            duration,
            halfDayTime
        });

        // Update affected leave requests
        updateAffectedLeaveRequests(date);

        alert('Public holiday added successfully!');
        modal.style.display = 'none';
        loadPublicHolidaysView();
    });
}

        function showAddUnrecordedLeaveModal() {
    const modal = document.getElementById('addUnrecordedLeaveModal');
    modal.style.display = 'flex';
    document.getElementById('unrecordedLeaveForm').reset();
    document.getElementById('unrecordedHalfDayGroup').style.display = 'none';
    document.getElementById('selectedEmployeesGroup').style.display = 'none';

    // Initialize date picker
    flatpickr("#unrecordedLeaveDate", {
        dateFormat: "d M Y"
    });

    // Populate employees checkbox list
    const checkboxList = document.getElementById('employeeCheckboxList');
    checkboxList.innerHTML = users
        .filter(u => u.role !== 'hr')
        .map(user => `
            <div class="employee-checkbox-item">
                <input type="checkbox" id="employee-${user.id}" value="${user.id}">
                <label for="employee-${user.id}">${user.name} (${user.supervisor})</label>
            </div>
        `).join('');
    
    // Add event listeners
    document.getElementById('unrecordedLeaveDuration').addEventListener('change', function() {
        const duration = this.value;
        document.getElementById('unrecordedHalfDayGroup').style.display = duration === 'half' ? 'block' : 'none';
    });
    
    document.getElementById('unrecordedLeaveScope').addEventListener('change', function() {
        const scope = this.value;
        document.getElementById('selectedEmployeesGroup').style.display = scope === 'selected' ? 'block' : 'none';
    });
    
    // Form submission
    document.getElementById('unrecordedLeaveForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('unrecordedLeaveName').value;
        const date = document.getElementById('unrecordedLeaveDate').value;
        const duration = document.getElementById('unrecordedLeaveDuration').value;
        const halfDayTime = duration === 'half' ? document.getElementById('unrecordedHalfDayTime').value : null;
        const scope = document.getElementById('unrecordedLeaveScope').value;
        
        let selectedEmployees = [];
        if (scope === 'selected') {
            const checkboxes = document.querySelectorAll('#employeeCheckboxList input[type="checkbox"]:checked');
            selectedEmployees = Array.from(checkboxes).map(cb => parseInt(cb.value));
        } else {
            selectedEmployees = users.filter(u => u.role !== 'hr').map(u => u.id);
        }
        
        // Add unrecorded leave
        unrecordedLeaves.push({
            id: unrecordedLeaves.length + 1,
            name,
            date,
            duration,
            halfDayTime,
            scope,
            employees: selectedEmployees,
            dateAdded: new Date().toISOString().split('T')[0]
        });

        // Update affected leave requests for selected employees
        if (scope === 'all' || selectedEmployees.includes(currentUser.id)) {
            updateAffectedLeaveRequests(date);
        }

        alert('Unrecorded leave added successfully!');
        modal.style.display = 'none';
        loadUnrecordedLeavesView();
    });
}
        function loadEmployeeListView() {
    if (currentUser.role !== 'hr') return;

    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Employee List</h1>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">All Employees</h2>
            </div>
            <div class="table-responsive">
                <table class="table compact-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Supervisor</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.username}</td>
                                <td>${user.supervisor}</td>
                                <td>${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewEmployeeDetails(${user.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${user.role !== 'hr' ? `
                                    <button class="btn btn-sm btn-info" onclick="viewLeaveBalance(${user.id})">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="editEmployeeLeaveBalance(${user.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
        function showManageSupervisorModal() {
            const modal = document.getElementById('manageSupervisorModal');
            modal.style.display = 'flex';
            document.getElementById('supervisorForm').reset();
            document.getElementById('addSupervisorGroup').style.display = 'block';
            document.getElementById('deleteSupervisorGroup').style.display = 'none';

            // Populate supervisors for delete
            const select = document.getElementById('supervisorToDelete');
            select.innerHTML = supervisors.map(sup => 
                `<option value="${sup.id}">${sup.name}</option>`
            ).join('');
            
            // Add event listener for action change
            document.getElementById('supervisorAction').addEventListener('change', function() {
                const action = this.value;
                document.getElementById('addSupervisorGroup').style.display = action === 'add' ? 'block' : 'none';
                document.getElementById('deleteSupervisorGroup').style.display = action === 'delete' ? 'block' : 'none';
            });
            
            // Form submission
            document.getElementById('supervisorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const action = document.getElementById('supervisorAction').value;

                if (action === 'add') {
                    const name = document.getElementById('newSupervisorName').value;
                    if (name.trim() === '') {
                        alert('Supervisor name cannot be empty');
                        return;
                    }
                    
                    supervisors.push({
                        id: supervisors.length + 1,
                        name
                    });
                    alert('Supervisor added successfully!');
                } else if (action === 'delete') {
                    const id = parseInt(document.getElementById('supervisorToDelete').value);
                    const index = supervisors.findIndex(s => s.id === id);
                    if (index !== -1) {
                        // Check if supervisor has employees
                        const hasEmployees = users.some(u => u.supervisor === supervisors[index].name);
                        if (hasEmployees) {
                            alert('Cannot delete supervisor with employees. Please move or delete employees first.');
                            return;
                        }
                        
                        supervisors.splice(index, 1);
                        alert('Supervisor deleted successfully!');
                    }
                }

                modal.style.display = 'none';
                loadSupervisorManagementView();
            });
        }

        function showManageEmployeeModal() {
            const modal = document.getElementById('manageEmployeeModal');
            modal.style.display = 'flex';
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeSelectionGroup').style.display = 'none';
            document.getElementById('employeeDetailsGroup').style.display = 'none';
            document.getElementById('addEmployeeGroup').style.display = 'none';
            document.getElementById('moveEmployeeGroup').style.display = 'none';
            document.getElementById('supervisorSupervisorsGroup').style.display = 'none';

            // Populate employees for move/delete
            const select = document.getElementById('selectedEmployee');
            select.innerHTML = users.filter(u => u.role !== 'hr').map(user => 
                `<option value="${user.id}">${user.name} (${user.supervisor})</option>`
            ).join('');

            // Populate supervisors
            const supSelect = document.getElementById('employeeSupervisor');
            supSelect.innerHTML = supervisors.map(sup => 
                `<option value="${sup.id}">${sup.name}</option>`
            ).join('');
            
            // Populate move to supervisor
            const moveSupSelect = document.getElementById('moveToSupervisor');
            moveSupSelect.innerHTML = supervisors.map(sup => 
                `<option value="${sup.id}">${sup.name}</option>`
            ).join('');
            
            // Populate supervisors for supervisor to manage
            const supervisorSupSelect = document.getElementById('supervisorSupervisors');
            supervisorSupSelect.innerHTML = supervisors.map(sup => 
                `<option value="${sup.id}">${sup.name}</option>`
            ).join('');
            
            // Add event listeners
            document.getElementById('employeeAction').addEventListener('change', function() {
                const action = this.value;
                document.getElementById('employeeSelectionGroup').style.display = action !== 'add' ? 'block' : 'none';
                document.getElementById('employeeDetailsGroup').style.display = 'block';
                document.getElementById('addEmployeeGroup').style.display = action === 'add' ? 'block' : 'none';
                document.getElementById('moveEmployeeGroup').style.display = action === 'move' ? 'block' : 'none';
                
                if (action === 'add') {
                    document.getElementById('employeeName').value = '';
                    document.getElementById('employeeUsername').value = '';
                    document.getElementById('employeeEmail').value = '';
                    document.getElementById('employeeRole').value = 'employee';
                    document.getElementById('supervisorSupervisorsGroup').style.display = 'none';
                }
            });
            
            document.getElementById('employeeRole').addEventListener('change', function() {
                const role = this.value;
                document.getElementById('supervisorSupervisorsGroup').style.display = role === 'supervisor' ? 'block' : 'none';
            });
            
            document.getElementById('selectedEmployee').addEventListener('change', function() {
                const employeeId = parseInt(this.value);
                const user = users.find(u => u.id === employeeId);
                if (user) {
                    const action = document.getElementById('employeeAction').value;
                    
                    if (action === 'move') {
                        const supervisor = supervisors.find(s => s.name === user.supervisor);
                        document.getElementById('moveToSupervisor').value = supervisor ? supervisor.id : '';
                    }
                }
            });
            
            // Form submission
            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const action = document.getElementById('employeeAction').value;

                if (action === 'add') {
                    const name = document.getElementById('employeeName').value;
                    const username = document.getElementById('employeeUsername').value;
                    const email = document.getElementById('employeeEmail').value;
                    const supervisorId = parseInt(document.getElementById('employeeSupervisor').value);
                    const role = document.getElementById('employeeRole').value;
                    
                    if (name.trim() === '' || username.trim() === '' || email.trim() === '') {
                        alert('Name, username and email cannot be empty');
                        return;
                    }
                    
                    if (users.some(u => u.username === username)) {
                        alert('Username already exists');
                        return;
                    }

                    const supervisor = supervisors.find(s => s.id === supervisorId);
                    
                    let manages = [];
                    if (role === 'supervisor') {
                        const selectedSups = Array.from(document.getElementById('supervisorSupervisors').selectedOptions).map(opt => parseInt(opt.value));
                        manages = users
                            .filter(u => selectedSups.includes(supervisors.find(s => s.name === u.supervisor)?.id))
                            .map(u => u.name);
                    }
                    
                    users.push({
                        id: users.length + 1,
                        name,
                        username,
                        password: "password123",
                        role,
                        supervisor: supervisor.name,
                        leaveBalances: JSON.parse(JSON.stringify(defaultLeaveBalances)),
                        manages,
                        email
                    });

                    alert('Employee added successfully!');
                } else if (action === 'move') {
                    const id = parseInt(document.getElementById('selectedEmployee').value);
                    const user = users.find(u => u.id === id);
                    if (user) {
                        const supervisorId = parseInt(document.getElementById('moveToSupervisor').value);
                        const supervisor = supervisors.find(s => s.id === supervisorId);
                        user.supervisor = supervisor.name;
                        alert('Employee moved successfully!');
                    }
                } else if (action === 'delete') {
                    const id = parseInt(document.getElementById('selectedEmployee').value);
                    if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
                        const index = users.findIndex(u => u.id === id);
                        if (index !== -1) {
                            users.splice(index, 1);
                            alert('Employee deleted successfully!');
                        }
                    } else {
                        return; // Don't close the modal if user cancels
                    }
                }

                modal.style.display = 'none';
                loadEmployeeManagementView();
            });
        }
        
        function loadDeletedEmployeesView() {
    if (currentUser.role !== 'hr') return;

    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Deleted Employees</h1>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Deleted Employee Records</h2>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Supervisor</th>
                            <th>Date Deleted</th>
                        </tr>
                    </thead>
                    <tbody id="deletedEmployeesTableBody">
                        <!-- Deleted employees will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function editEmployeeLeaveBalance(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const modal = document.getElementById('editLeaveBalanceModal');
    document.getElementById('balanceEmployeeId').value = userId;
    document.getElementById('balanceEmployeeName').textContent = `${user.name} (${user.supervisor})`;
    
    // Set default leave type and days
    document.getElementById('balanceLeaveType').value = 'annual';
    document.getElementById('balanceDays').value = user.leaveBalances.annual;
    
    // Update days when leave type changes
    document.getElementById('balanceLeaveType').addEventListener('change', function() {
        const leaveType = this.value;
        document.getElementById('balanceDays').value = user.leaveBalances[leaveType];
    });
    
    // Form submission
    document.getElementById('leaveBalanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const leaveType = document.getElementById('balanceLeaveType').value;
        const days = parseFloat(document.getElementById('balanceDays').value);

        user.leaveBalances[leaveType] = days;
        
        // Sync emergency leave with annual leave
        if (leaveType === 'annual') {
            user.leaveBalances.emergency = Math.min(7, days);
        } else if (leaveType === 'emergency') {
            user.leaveBalances.annual = days;
        }
        
        alert('Leave balance updated successfully!');
        modal.style.display = 'none';
        loadEmployeeManagementView();
    });

    modal.style.display = 'flex';
}
        
        function moveEmployee(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            showManageEmployeeModal();
            document.getElementById('employeeAction').value = 'move';
            document.getElementById('selectedEmployee').value = userId;
            
            const supervisor = supervisors.find(s => s.name === user.supervisor);
            document.getElementById('moveToSupervisor').value = supervisor ? supervisor.id : '';
        }

        // Close all modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Close modals when clicking close button
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Password toggle functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('toggle-password') || e.target.closest('.toggle-password')) {
                const toggle = e.target.classList.contains('toggle-password') ? e.target : e.target.closest('.toggle-password');
                const input = toggle.previousElementSibling;
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                toggle.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
            }
        });

        // Password validation
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            const saveBtn = document.getElementById('savePasswordBtn');
            let isValid = true;

            // Check length
            const lengthReq = document.getElementById('lengthReq');
            if (password.length >= 8) {
                lengthReq.classList.remove('invalid');
                lengthReq.classList.add('valid');
                lengthReq.querySelector('i').className = 'fas fa-check';
            } else {
                lengthReq.classList.remove('valid');
                lengthReq.classList.add('invalid');
                lengthReq.querySelector('i').className = 'far fa-circle';
                isValid = false;
            }

            // Check uppercase
            const upperReq = document.getElementById('upperReq');
            if (/[A-Z]/.test(password)) {
                upperReq.classList.remove('invalid');
                upperReq.classList.add('valid');
                upperReq.querySelector('i').className = 'fas fa-check';
            } else {
                upperReq.classList.remove('valid');
                upperReq.classList.add('invalid');
                upperReq.querySelector('i').className = 'far fa-circle';
                isValid = false;
            }

            // Check lowercase
            const lowerReq = document.getElementById('lowerReq');
            if (/[a-z]/.test(password)) {
                lowerReq.classList.remove('invalid');
                lowerReq.classList.add('valid');
                lowerReq.querySelector('i').className = 'fas fa-check';
            } else {
                lowerReq.classList.remove('valid');
                lowerReq.classList.add('invalid');
                lowerReq.querySelector('i').className = 'far fa-circle';
                isValid = false;
            }

            // Check number
            const numberReq = document.getElementById('numberReq');
            if (/\d/.test(password)) {
                numberReq.classList.remove('invalid');
                numberReq.classList.add('valid');
                numberReq.querySelector('i').className = 'fas fa-check';
            } else {
                numberReq.classList.remove('valid');
                numberReq.classList.add('invalid');
                numberReq.querySelector('i').className = 'far fa-circle';
                isValid = false;
            }

            // Check special char
            const specialReq = document.getElementById('specialReq');
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                specialReq.classList.remove('invalid');
                specialReq.classList.add('valid');
                specialReq.querySelector('i').className = 'fas fa-check';
            } else {
                specialReq.classList.remove('valid');
                specialReq.classList.add('invalid');
                specialReq.querySelector('i').className = 'far fa-circle';
                isValid = false;
            }

            // Check if passwords match
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchText = document.getElementById('passwordMatch');
            if (confirmPassword && password !== confirmPassword) {
                matchText.textContent = 'Passwords do not match';
                matchText.style.color = 'var(--danger)';
                isValid = false;
            } else if (confirmPassword) {
                matchText.textContent = 'Passwords match';
                matchText.style.color = 'var(--success)';
            } else {
                matchText.textContent = '';
            }

            // Enable/disable save button
            saveBtn.disabled = !isValid || !confirmPassword || password !== confirmPassword;
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            const matchText = document.getElementById('passwordMatch');
            const saveBtn = document.getElementById('savePasswordBtn');

            if (password && confirmPassword) {
                if (password === confirmPassword) {
                    matchText.textContent = 'Passwords match';
                    matchText.style.color = 'var(--success)';
                    saveBtn.disabled = false;
                } else {
                    matchText.textContent = 'Passwords do not match';
                    matchText.style.color = 'var(--danger)';
                    saveBtn.disabled = true;
                }
            } else {
                matchText.textContent = '';
                saveBtn.disabled = true;
            }
        });

        // Form submissions
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (currentUser.password !== currentPassword) {
                alert('Current password is incorrect');
                return;
            }
            
            currentUser.password = newPassword;
            alert('Password changed successfully!');
            document.getElementById('changePasswordModal').style.display = 'none';
        });

        document.getElementById('rejectLeaveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const leaveId = parseInt(document.getElementById('rejectLeaveId').value);
            const remark = document.getElementById('rejectRemark').value;

            const request = leaveRequests.find(req => req.id === leaveId);
            if (request) {
                request.status = 'rejected';
                request.rejectRemark = remark;
                
                // Send email notification
                sendLeaveStatusEmail(request);
                
                alert('Leave request rejected');
                document.getElementById('rejectLeaveModal').style.display = 'none';
                loadLeaveRequestsView();
                updateNotificationBadge();
            }
        });

        // Helper Functions
        function formatDate(dateString) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'approved': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'rejected': return 'badge-danger';
                default: return 'badge-info'; 
            } 
            `<td><span class="badge ${getStatusBadgeClass(req.status)}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span></td>`
        }

        function approveLeave(id) {
    const request = leaveRequests.find(req => req.id === id);
    if (!request) return;

    request.status = 'approved';
    
    const user = users.find(u => u.id === request.employeeId);
    if (user) {
        if (request.type === 'emergency') {
            // Emergency leave deducts from both annual and emergency balances
            user.leaveBalances.annual -= request.duration;
            user.leaveBalances.emergency -= request.duration;
            
            // Ensure emergency leave doesn't exceed 7 days or go negative
            user.leaveBalances.emergency = Math.max(0, Math.min(7, user.leaveBalances.emergency));
        } 
        else if (request.type === 'annual') {
            // Annual leave only deducts from annual balance
            user.leaveBalances.annual -= request.duration;
            // Emergency balance is capped at annual balance (max 7)
            user.leaveBalances.emergency = Math.min(7, user.leaveBalances.annual);
        } 
        else {
            // Other leave types
            user.leaveBalances[request.type] -= request.duration;
        }
    }
    
    sendLeaveStatusEmail(request);
    alert('Leave request approved');
    loadLeaveRequestsView();
    updateNotificationBadge();
}
        
        function cancelLeave(id) {
            if (confirm('Are you sure you want to cancel this leave request?')) {
                const index = leaveRequests.findIndex(req => req.id === id);
                if (index !== -1) {
                    leaveRequests.splice(index, 1);
                    alert('Leave request cancelled');
                    loadLeaveRequestsView();
                    updateNotificationBadge();
                }
            }
        }

        function modifyLeave(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    // Show the apply leave modal with the request details
    showApplyLeaveModal();
    
    // Populate the form with the existing request data
    document.getElementById('leaveType').value = request.type;
    document.getElementById('leaveDuration').value = request.duration === 0.5 ? 'half' : 
                                                    request.startDate !== request.endDate ? 'multiple' : 'full';
    
    if (request.duration === 0.5) {
        document.getElementById('halfDayTime').value = request.halfDayTime;
    }
    
    document.getElementById('leaveDate').value = request.startDate;
    document.getElementById('leaveStartDate').value = request.startDate;
    document.getElementById('leaveEndDate').value = request.endDate;
    document.getElementById('leaveRemark').value = request.remark;
    document.getElementById('contactNumber').value = request.contactNumber;
    
    // Store the leave ID to update instead of creating new
    document.getElementById('leaveForm').dataset.leaveId = leaveId;
    
    // Update the form submit handler to handle modification
    document.getElementById('leaveForm').onsubmit = function(e) {
        e.preventDefault();
        
        const leaveId = parseInt(this.dataset.leaveId);
        const requestIndex = leaveRequests.findIndex(req => req.id === leaveId);
        
        if (requestIndex === -1) return;
        
        // Update the existing request with new data
        const request = leaveRequests[requestIndex];
        request.type = document.getElementById('leaveType').value;
        request.duration = document.getElementById('leaveDuration').value === 'half' ? 0.5 : 
                          document.getElementById('leaveDuration').value === 'multiple' ? 
                          calculateDuration(document.getElementById('leaveStartDate').value, document.getElementById('leaveEndDate').value) : 1;
        request.halfDayTime = document.getElementById('leaveDuration').value === 'half' ? document.getElementById('halfDayTime').value : null;
        request.startDate = document.getElementById('leaveDuration').value === 'multiple' ? document.getElementById('leaveStartDate').value : document.getElementById('leaveDate').value;
        request.endDate = document.getElementById('leaveDuration').value === 'multiple' ? document.getElementById('leaveEndDate').value : document.getElementById('leaveDate').value;
        request.remark = document.getElementById('leaveRemark').value;
        request.contactNumber = document.getElementById('contactNumber').value;
        
        if (document.getElementById('leaveDocument').files[0]) {
            request.document = document.getElementById('leaveDocument').files[0].name;
        }
        
        alert('Leave request modified successfully!');
        document.getElementById('applyLeaveModal').style.display = 'none';
        loadLeaveRequestsView();
    };
}

function calculateDuration(startDate, endDate) {
    // Calculate duration in days excluding weekends and holidays
    let days = 0;
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
        // Skip weekends
        if (date.getDay() === 0 || date.getDay() === 6) continue;
        
        // Skip public holidays
        const isHoliday = publicHolidays.some(holiday => {
            const holidayDate = new Date(holiday.date);
            return holidayDate.toDateString() === date.toDateString();
        });
        if (isHoliday) continue;
        
        // Skip unrecorded leaves
        const isUnrecordedLeave = unrecordedLeaves.some(leave => {
            const leaveDate = new Date(leave.date);
            return leaveDate.toDateString() === date.toDateString() && 
                  (leave.scope === 'all' || (leave.scope === 'selected' && leave.employees.includes(currentUser.id)));
        });
        if (isUnrecordedLeave) continue;
        
        days += 1;
    }
    
    return days;
}

        function deleteHoliday(id) {
            if (confirm('Are you sure you want to delete this holiday?')) {
                const index = publicHolidays.findIndex(h => h.id === id);
                if (index !== -1) {
                    publicHolidays.splice(index, 1);
                    loadPublicHolidaysView();
                }
            }
        }

        function deleteUnrecordedLeave(id) {
            if (confirm('Are you sure you want to delete this unrecorded leave?')) {
                const index = unrecordedLeaves.findIndex(l => l.id === id);
                if (index !== -1) {
                    unrecordedLeaves.splice(index, 1);
                    loadUnrecordedLeavesView();
                }
            }
        }

        function deleteSupervisor(id) {
            if (confirm('Are you sure you want to delete this supervisor? This action cannot be undone.')) {
                const index = supervisors.findIndex(s => s.id === id);
                if (index !== -1) {
                    // Check if supervisor has employees
                    const hasEmployees = users.some(u => u.supervisor === supervisors[index].name);
                    if (hasEmployees) {
                        alert('Cannot delete supervisor with employees. Please move or delete employees first.');
                        return;
                    }
                    
                    supervisors.splice(index, 1);
                    loadSupervisorManagementView();
                }
            }
        }

        function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
                const index = users.findIndex(u => u.id === id);
                if (index !== -1) {
                    users.splice(index, 1);
                    loadEmployeeManagementView();
                }
            }
        }

        // Email functions (simulated)
        function sendLeaveApplicationEmail(request) {
            // In a real app, this would send an actual email
            console.log(`Email sent to approvers about leave application from ${request.employee}`);
            
            // Get the employee's supervisor and HR
            const approvers = [];
            
            if (request.approver) {
                const supervisor = users.find(u => u.name === request.approver);
                if (supervisor && supervisor.email) {
                    approvers.push(supervisor.email);
                }
            }
            
            // Always notify HR
            const hrUsers = users.filter(u => u.role === 'hr' && u.email);
            hrUsers.forEach(hr => approvers.push(hr.email));
            
            // Simulate sending email
            const emailContent = `
                Subject: New Leave Application - ${request.employee}
                
                A new leave application has been submitted by ${request.employee}.
                
                Details:
                - Type: ${request.type}
                - Dates: ${formatDate(request.startDate)} ${request.startDate !== request.endDate ? `to ${formatDate(request.endDate)}` : ''}
                - Duration: ${request.duration} days
                - Remark: ${request.remark}
                
                Please review this application in the Leave Management System.
                
                This is an automated message from Archipelago Group LMS.
            `;
            
            console.log(`Email sent to: ${approvers.join(', ')}`);
            console.log(emailContent);
        }

        function viewDocument(filename) {
    alert(`Viewing document: ${filename}\nIn a real application, this would open the document.`);
}

        function sendLeaveStatusEmail(request) {
            // In a real app, this would send an actual email
            console.log(`Email sent to employee about leave status update`);
            
            // Get the employee
            const employee = users.find(u => u.id === request.employeeId);
            if (!employee || !employee.email) return;
            
            // Simulate sending email
            const emailContent = `
                Subject: Your Leave Application Status - ${request.status}
                
                Your leave application has been ${request.status}.
                
                Details:
                - Type: ${request.type}
                - Dates: ${formatDate(request.startDate)} ${request.startDate !== request.endDate ? `to ${formatDate(request.endDate)}` : ''}
                - Duration: ${request.duration} days
                - Remark: ${request.remark}
                ${request.status === 'rejected' ? `- Rejection Remark: ${request.rejectRemark}` : ''}
                
                This is an automated message from Archipelago Group LMS.
            `;
            
            console.log(`Email sent to: ${employee.email}`);
            console.log(emailContent);
            
            // Also notify HR
            const hrUsers = users.filter(u => u.role === 'hr' && u.email);
            hrUsers.forEach(hr => {
                const hrEmailContent = `
                    Subject: Leave Application ${request.status} - ${request.employee}
                    
                    The leave application from ${request.employee} has been ${request.status}.
                    
                    Details:
                    - Type: ${request.type}
                    - Dates: ${formatDate(request.startDate)} ${request.startDate !== request.endDate ? `to ${formatDate(request.endDate)}` : ''}
                    - Duration: ${request.duration} days
                    - Remark: ${request.remark}
                    ${request.status === 'rejected' ? `- Rejection Remark: ${request.rejectRemark}` : ''}
                    
                    This is an automated message from Archipelago Group LMS.
                `;
                
                console.log(`Email sent to HR (${hr.email})`);
                console.log(hrEmailContent);
            });
        }

        // Initialize password toggle on login page
        document.querySelector('.toggle-password').addEventListener('click', function() {
            const input = this.previousElementSibling;
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
        });
        function loadDeletedEmployeesView() {
    if (currentUser.role !== 'hr') return;

    mainContent.innerHTML = `
        <div class="page-title">
            <h1>Deleted Employees</h1>
        </div>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Deleted Employee Records</h2>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Supervisor</th>
                            <th>Date Deleted</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center;">No deleted employee records</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
function viewEmployeeDetails(userId, containerId = 'employeeDetailsContent') {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const content = document.getElementById(containerId);
    
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">${user.name}'s Details</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="width: 150px; height: 150px; border-radius: 50%; background-color: #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${user.profilePic ? 
                            `<img src="${user.profilePic}" style="width: 100%; height: 100%; object-fit: cover;">` :
                            `<i class="fas fa-user" style="font-size: 60px; color: #777;"></i>`
                        }
                    </div>
                    <div style="flex: 1;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p><strong>Username:</strong> ${user.username}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Supervisor:</strong> ${user.supervisor}</p>
                                <p><strong>Role:</strong> ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                            </div>
                            <div>
                                <p><strong>Department:</strong> ${user.department || 'N/A'}</p>
                                <p><strong>Position:</strong> ${user.position || 'N/A'}</p>
                                <p><strong>Join Date:</strong> ${user.joinDate || 'N/A'}</p>
                                <p><strong>Status:</strong> Active</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editEmployeeDetails(${user.id})">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                    <button class="btn btn-info" onclick="viewLeaveBalance(${user.id})">
                        <i class="fas fa-calendar"></i> View Leave Balance
                    </button>
                    ${currentUser.role === 'hr' ? `
                    <button class="btn btn-danger" onclick="deleteEmployee(${user.id})">
                        <i class="fas fa-trash"></i> Delete Employee
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    // If this is called from the modal, show the modal
    if (containerId === 'employeeDetailsContent') {
        document.getElementById('viewEmployeeModal').style.display = 'flex';
    }
}
function editEmployeeDetails(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const modal = document.getElementById('editEmployeeModal') || createEditEmployeeModal();
    modal.style.display = 'flex';

    // Populate form with user data
    document.getElementById('editEmployeeId').value = user.id;
    document.getElementById('editEmployeeName').value = user.name;
    document.getElementById('editEmployeeUsername').value = user.username;
    document.getElementById('editEmployeeEmail').value = user.email || '';
    document.getElementById('editEmployeeDepartment').value = user.department || '';
    document.getElementById('editEmployeePosition').value = user.position || '';
    document.getElementById('editEmployeeJoinDate').value = user.joinDate || '';
    
    // Populate supervisor dropdown
    const supervisorSelect = document.getElementById('editEmployeeSupervisor');
    supervisorSelect.innerHTML = supervisors.map(sup => 
        `<option value="${sup.id}" ${sup.name === user.supervisor ? 'selected' : ''}>${sup.name}</option>`
    ).join('');

    // Only show role field for HR users editing other users
    const roleFieldContainer = document.getElementById('editEmployeeRoleContainer');
    if (currentUser.role === 'hr' && currentUser.id !== userId) {
        roleFieldContainer.style.display = 'block';
        document.getElementById('editEmployeeRole').value = user.role;
    } else {
        roleFieldContainer.style.display = 'none';
    }
}

function createEditEmployeeModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'editEmployeeModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmployeeId">
                <div class="form-group">
                    <label for="editEmployeeName" class="form-label">Full Name</label>
                    <input type="text" id="editEmployeeName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editEmployeeUsername" class="form-label">Username</label>
                    <input type="text" id="editEmployeeUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editEmployeeEmail" class="form-label">Email</label>
                    <input type="email" id="editEmployeeEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editEmployeeDepartment" class="form-label">Department</label>
                    <input type="text" id="editEmployeeDepartment" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editEmployeePosition" class="form-label">Position</label>
                    <input type="text" id="editEmployeePosition" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editEmployeeJoinDate" class="form-label">Join Date</label>
                    <input type="date" id="editEmployeeJoinDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="editEmployeeSupervisor" class="form-label">Supervisor</label>
                    <select id="editEmployeeSupervisor" class="form-select" required>
                        ${supervisors.map(sup => `<option value="${sup.id}">${sup.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" id="editEmployeeRoleContainer" style="display: none;">
                    <label for="editEmployeeRole" class="form-label">Role</label>
                    <select id="editEmployeeRole" class="form-select">
                        <option value="employee">Employee</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="hr">HR</option>
                    </select>
                    <small class="text-muted">Only editable by HR for other users</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger close-modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);

    // Initialize date picker
    flatpickr("#editEmployeeJoinDate", {
        dateFormat: "Y-m-d"
    });

    // Form submission
    document.getElementById('editEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = parseInt(document.getElementById('editEmployeeId').value);
        const user = users.find(u => u.id === userId);
        if (!user) return;

        // Update user details
        user.name = document.getElementById('editEmployeeName').value;
        user.username = document.getElementById('editEmployeeUsername').value;
        user.email = document.getElementById('editEmployeeEmail').value;
        user.department = document.getElementById('editEmployeeDepartment').value;
        user.position = document.getElementById('editEmployeePosition').value;
        user.joinDate = document.getElementById('editEmployeeJoinDate').value;
        
        const supervisorId = parseInt(document.getElementById('editEmployeeSupervisor').value);
        const supervisor = supervisors.find(s => s.id === supervisorId);
        if (supervisor) {
            user.supervisor = supervisor.name;
        }
        
        user.role = document.getElementById('editEmployeeRole').value;

        alert('Employee details updated successfully!');
        modal.style.display = 'none';
        
        // Refresh the current view
        if (currentUser.role === 'hr') {
            loadEmployeeManagementView();
        } else {
            loadProfileView();
        }
    });

    // Close modal when clicking outside or on close button
    modal.addEventListener('click', function(e) {
        if (e.target === modal || e.target.classList.contains('close-modal')) {
            modal.style.display = 'none';
        }
    });

    return modal;
}
function viewDocument(filename) {
    alert(`Viewing document: ${filename}\nIn a real application, this would open the document viewer.`);
}
function loadEmployeeLeaveBalance(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const container = document.getElementById('leaveBalanceContainer');
    const tableBody = document.querySelector('#leaveBalanceTable tbody');
    
    tableBody.innerHTML = `
        <tr>
            <td>Annual Leave</td>
            <td>${user.leaveBalances.annual} days</td>
        </tr>
        <tr>
            <td>Emergency Leave</td>
            <td>${user.leaveBalances.emergency} days</td>
        </tr>
        <tr>
            <td>Medical Leave</td>
            <td>${user.leaveBalances.medical} days</td>
        </tr>
        <tr>
            <td>Marriage Leave</td>
            <td>${user.leaveBalances.marriage} days</td>
        </tr>
        <tr>
            <td>Maternity Leave</td>
            <td>${user.leaveBalances.maternity} days</td>
        </tr>
        <tr>
            <td>Paternity Leave</td>
            <td>${user.leaveBalances.paternity} days</td>
        </tr>
        <tr>
            <td>Compassionate Leave</td>
            <td>${user.leaveBalances.compassionate} days</td>
        </tr>
        <tr>
            <td>Study Leave</td>
            <td>${user.leaveBalances.study} days</td>
        </tr>
        <tr>
            <td>Examination Leave</td>
            <td>${user.leaveBalances.examination} days</td>
        </tr>
        <tr>
            <td>Replacement Leave</td>
            <td>${user.leaveBalances.replacement} days</td>
        </tr>
    `;

    container.style.display = 'block';
    
    // Add event listener for edit button
    document.getElementById('editLeaveBalanceBtn').onclick = function() {
        editEmployeeLeaveBalance(userId);
    };
}

function editEmployeeLeaveBalance(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const modal = document.getElementById('editLeaveBalanceModal');
    document.getElementById('balanceEmployeeId').value = userId;
    
    // Populate the form
    document.getElementById('balanceEmployee').value = userId;
    document.getElementById('balanceLeaveType').value = 'annual';
    document.getElementById('balanceDays').value = user.leaveBalances.annual;

    // Add event listeners
    document.getElementById('balanceLeaveType').addEventListener('change', function() {
        const leaveType = this.value;
        document.getElementById('balanceDays').value = user.leaveBalances[leaveType];
    });

    // Form submission
    document.getElementById('leaveBalanceForm').onsubmit = function(e) {
        e.preventDefault();
        
        const leaveType = document.getElementById('balanceLeaveType').value;
        const days = parseFloat(document.getElementById('balanceDays').value);
        
        // Update the balance
        user.leaveBalances[leaveType] = days;
        
        // If annual or emergency leave is updated, sync the other one
        if (leaveType === 'annual') {
            user.leaveBalances.emergency = Math.min(7, days);
        } else if (leaveType === 'emergency') {
            user.leaveBalances.annual = days;
            user.leaveBalances.emergency = Math.min(7, days);
        }
        
        alert('Leave balance updated successfully!');
        modal.style.display = 'none';
        loadEmployeeLeaveBalance(userId);
    };

    modal.style.display = 'flex';
}
function viewLeaveBalance(userId, leaveType = null) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const modal = document.getElementById('viewLeaveBalanceModal');
    const tableBody = document.getElementById('leaveBalanceTableBody');
    
    // Filter leave types if specific type is requested
    const leaveTypes = leaveType ? 
        [[leaveType, user.leaveBalances[leaveType]]] : 
        Object.entries(user.leaveBalances);
    
    tableBody.innerHTML = leaveTypes.map(([type, balance]) => `
        <tr>
            <td>${type.charAt(0).toUpperCase() + type.slice(1)} Leave</td>
            <td>${type === 'emergency' ? Math.min(7, balance) : balance} days</td>
        </tr>
    `).join('');

    modal.style.display = 'flex';

    // Proper close functionality
    modal.querySelector('.close-modal').addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

function modifyLeaveRequest(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    if (confirm('Modifying this leave will require re-approval. Continue?')) {
        // Show apply leave modal with existing data
        showApplyLeaveModal();
        
        // Populate form with existing leave data
        document.getElementById('leaveType').value = request.type;
        document.getElementById('leaveDuration').value = request.duration === 0.5 ? 'half' : 
                                                        request.startDate !== request.endDate ? 'multiple' : 'full';
        
        if (request.duration === 0.5) {
            document.getElementById('halfDayTime').value = request.halfDayTime;
            document.getElementById('halfDayGroup').style.display = 'block';
        }
        
        if (request.startDate !== request.endDate) {
            document.getElementById('dateRangeGroup').style.display = 'block';
            document.getElementById('singleDateGroup').style.display = 'none';
            document.getElementById('leaveStartDate').value = request.startDate;
            document.getElementById('leaveEndDate').value = request.endDate;
        } else {
            document.getElementById('leaveDate').value = request.startDate;
        }
        
        document.getElementById('leaveRemark').value = request.remark;
        document.getElementById('contactNumber').value = request.contactNumber || '';
        
        // Set flag that we're modifying an existing request
        document.getElementById('leaveForm').dataset.modifying = leaveId;
        
        // Close the details modal
        document.getElementById('viewLeaveModal').style.display = 'none';
        document.body.removeChild(document.getElementById('viewLeaveModal'));
    }
}

function cancelLeaveRequest(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    if (confirm('Are you sure you want to cancel this leave request?')) {
        // If the request was approved, restore leave balances
        if (request.status === 'approved') {
            const user = users.find(u => u.id === request.employeeId);
            if (user) {
                if (request.type === 'emergency') {
                    user.leaveBalances.annual += request.duration;
                    user.leaveBalances.emergency += request.duration;
                    user.leaveBalances.emergency = Math.max(0, Math.min(7, user.leaveBalances.emergency));
                } 
                else if (request.type === 'annual') {
                    user.leaveBalances.annual += request.duration;
                    user.leaveBalances.emergency = Math.min(7, user.leaveBalances.annual);
                } 
                else {
                    user.leaveBalances[request.type] += request.duration;
                }
            }
        }

        // Remove the request
        const index = leaveRequests.findIndex(req => req.id === leaveId);
        if (index !== -1) {
            leaveRequests.splice(index, 1);
        }

        alert('Leave request cancelled successfully!');
        loadLeaveRequestsView();
        updateNotificationBadge();
    }
}

function modifyLeaveRequest(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    if (confirm('Modifying this leave will require re-approval. Continue?')) {
        request.status = 'pending';
        alert('Leave request modified and sent for re-approval');
        loadLeaveRequestsView();
        updateNotificationBadge();
    }
}
function calculateLeaveDuration(startDate, endDate, duration) {
    if (duration === 'half') return 0.5;
    if (duration === 'full') return 1;
    
    let days = 0;
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
        // Skip weekends
        if (date.getDay() === 0 || date.getDay() === 6) continue;
        
        // Skip public holidays
        const isHoliday = publicHolidays.some(holiday => {
            const holidayDate = new Date(holiday.date);
            return holidayDate.toDateString() === date.toDateString();
        });
        if (isHoliday) continue;
        
        // Skip unrecorded leaves
        const isUnrecordedLeave = unrecordedLeaves.some(leave => {
            const leaveDate = new Date(leave.date);
            return leaveDate.toDateString() === date.toDateString() && 
                  (leave.scope === 'all' || (leave.scope === 'selected' && leave.employees.includes(currentUser.id)));
        });
        if (isUnrecordedLeave) continue;
        
        days += 1;
    }
    
    return days;
}

function saveLeaveModification(leaveId) {
    const request = leaveRequests.find(req => req.id === leaveId);
    if (!request) return;

    const leaveType = document.getElementById(`modifyLeaveType-${leaveId}`).value;
    const duration = document.getElementById(`modifyDuration-${leaveId}`).value;
    const halfDayTime = duration === 'half' ? document.getElementById(`modifyHalfDayTime-${leaveId}`).value : null;
    const startDate = duration === 'multiple' ? document.getElementById(`modifyStartDate-${leaveId}`).value : document.getElementById(`modifyLeaveDate-${leaveId}`).value;
    const endDate = duration === 'multiple' ? document.getElementById(`modifyEndDate-${leaveId}`).value : document.getElementById(`modifyLeaveDate-${leaveId}`).value;
    const remark = document.getElementById(`modifyRemark-${leaveId}`).value;
    const contactNumber = document.getElementById(`modifyContactNumber-${leaveId}`).value;
    const documentFile = document.getElementById(`modifyDocument-${leaveId}`).files[0] ? 
        document.getElementById(`modifyDocument-${leaveId}`).files[0].name : 
        request.document;

    // Calculate new duration
    let days = calculateLeaveDuration(startDate, endDate, duration);

    // If previously approved, restore the leave balance first
    if (request.status === 'approved') {
        const user = users.find(u => u.id === request.employeeId);
        if (user) {
            if (request.type === 'emergency') {
                user.leaveBalances.annual += request.duration;
                user.leaveBalances.emergency += request.duration;
            } else if (request.type === 'annual') {
                user.leaveBalances.annual += request.duration;
            } else {
                user.leaveBalances[request.type] += request.duration;
            }
        }
    }

    // Update the request
    request.type = leaveType;
    request.startDate = startDate;
    request.endDate = endDate;
    request.duration = days;
    request.halfDayTime = halfDayTime;
    request.remark = remark;
    request.contactNumber = contactNumber;
    request.document = documentFile;
    request.status = 'pending'; // Reset status for re-approval

    // Close the modification tab
    toggleModificationTab(leaveId);
    
    // Show success message and reload the view
    alert('Leave request modified successfully!');
    loadLeaveRequestsView();
}
function toggleModificationTab(leaveId) {
    const tab = document.getElementById(`modificationTab-${leaveId}`);
    if (tab) {
        tab.classList.toggle('active');
        
        // Scroll to the modification form
        if (tab.classList.contains('active')) {
            tab.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}
    </script>
</body>
</html>